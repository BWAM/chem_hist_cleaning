---
title: "Compile historic chem"
author: "Gavin Lemley"
date: "December 18, 2019"
output: html_document
---

Load libraries and input files
```{r}
library(tidyverse)

root.dir <- rprojroot::find_root("chem_hist_cleaning.Rproj")

# result.2016 <- read.csv(file.path(root.dir, "data/2016_ribs_result.csv"), stringsAsFactors = FALSE) %>%
#   rename_all(tolower)
# sample.2016 <- read.csv(file.path(root.dir, "data/2016_ribs_sample.csv"), stringsAsFactors = FALSE) %>%
#   rename_all(tolower)

equis.result <- read_csv(file.path(root.dir, "data/equis_results_history.csv")) %>% 
  rename_all(tolower) %>%
  rename(sample_delivery_group = lab_sdg)
equis.sample <- read_csv(file.path(root.dir, "data/equis_sample_history.csv")) %>% 
  rename_all(tolower) %>% 
  group_by(sys_sample_code) %>% 
  mutate(n = n()) %>% 
  arrange(n)

sites <- readxl::read_excel(file.path(root.dir, "sites/2020_04_21_S_Site_2020-04-29.xlsx"))


```

Join with sites table to add modern site IDs
```{r}

# Load in RIBS crosswalk table. Must use this and not sites table due to duplicate RIBS IDs assigned to singe SBU ids (not reflected in sites table; crosswalk retains duplicates)
ribs.crosswalk <- readxl::read_excel(file.path(root.dir, "ribsid_join/RIBSchem_historic_BioSiteJoin_2020-04-28.xlsx")) %>% 
  rename(sys_loc_code = ADJUST_RIBS_ID) %>% 
  select(sys_loc_code, SBU_ID)

equis.sample.siteids <- left_join(equis.sample, ribs.crosswalk, by = "sys_loc_code") %>% 
  select(SBU_ID, everything())

equis.sample.siteids.nomatch <- equis.sample.siteids %>% 
  filter(is.na(SBU_ID)) %>% 
  mutate(year = format(as.Date(sample_date, format="%m/%d/%Y"),"%Y")) %>% 
  select(year, everything())

missing.ribsids <- unique(equis.sample.siteids.nomatch$sys_loc_code) 

# Import EQuIS locations table to see if these un-crosswalked sites are present 
equis.location <- read_csv(file.path(root.dir, "data/equis_location_history.csv")) %>% 
  rename(LATITUDE = LONGITUDE,
         LONGITUDE = LATITUDE)

equis.location.missingribsids <- equis.location %>% 
  filter(SYS_LOC_CODE %in% missing.ribsids,
         SYS_LOC_CODE != "QA_QC") %>% 
  select(SYS_LOC_CODE, LATITUDE, LONGITUDE, SURF_ELEV, ELEV_UNIT, LOC_NAME, LOC_DESC, LOC_COUNTY_CODE, DEC_REGION, LOC_MAJOR_BASIN, 
         NYS_DRAINAGE_BASIN_CODE, STREAM_MILE) %>% 
  mutate(lat_long = paste0(LATITUDE, "_", LONGITUDE))

# missing.diff <- anti_join(equis.location.missingribsids, equis.location.missingribsids2)

# write_csv(equis.location.missingribsids, file.path(root.dir, "ribsid_join/equis.location.missingribsids.csv"))


```


Join sample and result tables and check for issues
```{r}
# SDG not populated for all records. Must use only sys_sample_code.

equis.join <- left_join(equis.sample, equis.result, by = "sys_sample_code")
# 110 extra records created

# See if there are records in each table that don't have matches in the other
equis.sample.nomatch <- anti_join(equis.sample, equis.result, by = "sys_sample_code")
equis.result.nomatch <- anti_join(equis.result, equis.sample, by = "sys_sample_code")


```



Remove field YSI data from equis data, and lab data from field table, and set aside for binding later
```{r}
# First subset out by results table (where there's more info to deduce field vs lab data) then %in% match to subset samples table

equis.result.field <- equis.result %>% 
  filter(grepl("*FS", sys_sample_code))
equis.result.lab <- equis.result %>% 
  filter(!grepl("*FS", sys_sample_code))

# Looking at unique parameters in field and lab subsets

# > unique(equis.result.field$cas_rn)
# [1] TURB        TEMP        SC          DISS_OXYGEN PH          PHWATER     COLIF       FECCOLIFORM

# > unique(equis.result.lab$cas_rn)
#  [1] TVS         TSO         TDS         PH          HARD        SC          FECCOLIFORM COLIF       TSS         TEMP        DISS_OXYGEN TOC        
# [13] 14265-44-2  7723-14-0   14797-65-0  NO3NO2N     14797-55-8  KN          7664-41-7   ALK         16887-00-6  14808-79-8  16984-48-8  7439-97-6  
# [25] 7439-92-1   7440-02-0   7440-43-9   7440-50-8   7429-90-5   7439-89-6   7439-95-4   7439-96-5   7440-09-7   7440-23-5   7440-66-6   7440-70-2  
# [37] TURB        75-27-4     79-01-6     TOTPHEN     124-48-1    127-18-4    67-66-3     74-87-3     75-01-4     75-09-2     7440-22-4   7440-38-2  
# [49] 7727-37-9   PHWATER     121-48-1    DOC         17060-07-0  2037-26-5   460-00-4    PDORTHO     7440-44-0   COND        ARC-NO3NO2N 479-61-8 


### Cleaning up field data

# Subset fecal data from field for binding to lab later
equis.result.lab.fecal <- equis.result.field %>% 
  filter(grepl("COLIF|FECCOLIFORM", cas_rn))
# Remove fecal data from field
equis.result.field <- equis.result.field %>% 
  filter(!grepl("COLIF|FECCOLIFORM", cas_rn))

# Subset turbidity data from field for binding to lab later
equis.result.lab.turb <- equis.result.field %>% 
  filter(grepl("TURB", cas_rn))
# Remove turbidity data from field
equis.result.field <- equis.result.field %>% 
  filter(!grepl("TURB", cas_rn))

# Subset SC data to invesigate and confirm if field-derive or lab-derived
equis.result.field.SC <- equis.result.field %>% 
  filter(grepl("SC", cas_rn))
rm(equis.result.field.SC)
  #conclusion: no indiciation that any records are lab data.

# Subset PH data to invesigate and confirm if field-derive or lab-derived
equis.result.field.PH <- equis.result.field %>% 
  filter(grepl("PH|PHWATER", cas_rn))
rm(equis.result.field.PH)
  #conclusion: no indiciation that any records are lab data.

# Subset temp data to invesigate and confirm if field-derive or lab-derived
equis.result.field.temp <- equis.result.field %>% 
  filter(grepl("TEMP", cas_rn))
rm(equis.result.field.temp)
  #conclusion: no indiciation that any records are lab data.


### Cleaning up lab data

# Subset DO data from lab for binding to field later
equis.result.field.DO <- equis.result.lab %>% 
  filter(grepl("DISS_OXYGEN", cas_rn))
# Remove DO data from lab
equis.result.lab <- equis.result.lab %>% 
  filter(!grepl("DISS_OXYGEN", cas_rn))

# Subset SC data to invesigate and confirm if field-derive or lab-derived
equis.result.lab.SC <- equis.result.lab %>% 
  filter(grepl("SC", cas_rn))
rm(equis.result.lab.SC)
  #conclusion: no indiciation that any records are field data.

# Subset COND data to invesigate and confirm if field-derive or lab-derived
equis.result.lab.COND <- equis.result.lab %>% 
  filter(grepl("COND", cas_rn))
rm(equis.result.lab.COND)
  #conclusion: All confirmed lab data.

# Subset PH data to invesigate and confirm if field-derived or lab-derived
equis.result.lab.PH <- equis.result.lab %>% 
  filter(grepl("PH|PHWATER", cas_rn))
rm(equis.result.lab.PH)
  #conclusion: no indiciation that any records are field data.

# Subset TEMP data to invesigate and confirm if field-derive or lab-derived
equis.result.lab.TEMP <- equis.result.lab %>% 
  filter(grepl("TEMP", cas_rn))
rm(equis.result.lab.TEMP)
  #conclusion: no indiciation that any records are field data.


### Overall conclusion: 2008 data for crossover params (PH, PHWATER, COND, SC, TEMP) looks suspcicious and should be investigated when all data is together. Move ahead with current designations in data.

```

Bind orphaned field and lab data to their respective tables and create their repsective sample tables
```{r}

equis.result.field <- bind_rows(equis.result.field, equis.result.field.DO)

equis.result.lab <- bind_rows(equis.result.lab, equis.result.lab.fecal, equis.result.lab.turb)

rm(equis.result.field.DO, equis.result.lab.fecal, equis.result.lab.turb)

# Create lab and field sample tables from existing results
 equis.sample.field <- equis.sample[equis.sample$sys_sample_code %in% equis.result.field$sys_sample_code, ]
#   check to make sure length is same as unique sys_sample_codes
#     > length(unique(equis.result.field$sys_sample_code))
#     [1] 5564
 
 equis.sample.lab <- equis.sample[equis.sample$sys_sample_code %in% equis.result.lab$sys_sample_code, ]
#   check to make sure length is same as unique sys_sample_codes
#     > length(unique(equis.result.lab$sys_sample_code))
#     [1] 15195
 
# Export field data for appending to appropirate field table
 
```

Investigate field name matches between equis and 2016 data
### SORT OUT 2016 DUPLICATE SAMPLE NAME ISSUES BEFORE PROCESSING BELOW DATA ###
### See fixing_2016_chem.Rmd ###
```{r}
# Get column names and see which match
names_equis.result <- names(equis.result)
names_result.2016 <- names(result.2016)

result.unmatch_cols.eq <- names_equis.result[!names_equis.result %in% names_result.2016]
# Output: > result.unmatch_cols.eq
# [1] "test_comment"        "result_text"         "result_numeric"      "results_historic_id" "facility_name"  

# "test_comment" can be ignored (all NAs)
# "result_text" can be ignored (identical to result_numeric) 
# "results_historic_id" and "facility_name" can be ignored, as these are equis fields.

result.unmatch_cols.2016 <- names_result.2016[!names_result.2016 %in% names_equis.result]
# Output: > result.unmatch_cols.2016
# [1] "comment"      "result_value" 
# "comment" can be ignored (all NAs)
# "result_value" will become "result_numeric"


names_equis.sample <- names(equis.sample)
names_sample.2016 <- names(sample.2016)

sample.unmatch_cols.eq <- names_equis.sample[!names_equis.sample %in% names_sample.2016]
# Output: > sample.unmatch_cols.eq
# [1] "sample_method" "comments"      "facility_name"
# "sample_method" 

sample.unmatch_cols.2016 <- names_sample.2016[!names_sample.2016 %in% names_equis.sample]
# > sample.unmatch_cols.2016
# [1] "sampling_technique" "comment"            "siteid"
# "sampling_technique" is blank and will be populated with "SOP201" and append to equis "sample_method""
# "comment" is blank
# "siteid" will be bound with sys_loc_code

```

Populate fields as needed and rename to match 2016 and equis data
```{r}

result.2016 <- result.2016 %>% 
  rename(result_numeric = result_value) %>% 
  select(-comment)


sample.2016$sampling_technique <- "SOP201" 

sample.2016 <- sample.2016 %>% 
  select(-c(comment, sys_loc_code)) %>% 
  rename(sampling_method = sampling_technique) %>%
  rename(sys_loc_code = siteid)
  
  
  # as.character(sample.2016$sampling_technique)

```


Rename appropriate columns and bind data
```{r}

```


Rename fields to match new database field names (USE NEW UNIFIED DATA MODEL FIELDS)
```{r}

```

