---
title: "compile_2017-2019"
output: html_document
---

Load libraries, find the R-project root directory, and specify input/output files.
```{r}
library(tidyverse)
root.dir <- rprojroot::find_root("chem_hist_cleaning.Rproj")

##### User-defined variables #####

# Must create the directories specified in input.path and output.path #
input.path <- file.path(root.dir, "data", "2017-2019")
output.path <- file.path(root.dir, "data_output", "2017-2019", "output")

output.filename <- paste0("SMAS_chemistry_2017-2018_BATCH_1", Sys.Date(), ".csv")

#Specify sites reference table
# sites.master <- read.csv(file.path(root.dir, "data_input/site_tables/20191224_Site_Field_cleaned_final.csv"))

##################################

```


Load in SAMPLE, RESULT, and BATCH files.
```{r}

SAMPLE.2017 <- read_csv(file.path(root.dir, "data/2017-2019/2017_chem_preqaqc_SAMPLE-SBU_complete_2020-03-26.csv"))
SAMPLE.2018 <- read_csv(file.path(root.dir, "data/2017-2019/2018_chem_preqaqc_SAMPLE-SBU_complete_2020-03-25.csv"))
SAMPLE.2019 <- read_csv(file.path(root.dir, "data/2017-2019/2019_chem_preqaqc_SAMPLE-SBU_Mohawk_complete_2020-03-25.csv"))

RESULT.2017 <- read_csv(file.path(root.dir, "data/2017-2019/2017_chem_preqaqc_RESULT-SBU_complete_2020-03-26.csv"), col_types = cols(fraction = col_character()))
RESULT.2018 <- read_csv(file.path(root.dir, "data/2017-2019/2018_chem_preqaqc_RESULT-SBU_complete_2020-03-25.csv"))
RESULT.2019 <- read_csv(file.path(root.dir, "data/2017-2019/2019_chem_preqaqc_RESULT-SBU_Mohawk_complete_2020-03-25.csv"))

BATCH.2017 <- read_csv(file.path(root.dir, "data/2017-2019/2017_chem_preqaqc_BATCH-SBU_complete_2020-03-26.csv"), col_types = cols(fraction = col_character()))
BATCH.2018 <- read_csv(file.path(root.dir, "data/2017-2019/2018_chem_preqaqc_BATCH-SBU_complete_2020-03-26.csv"))
BATCH.2019 <- read_csv(file.path(root.dir, "data/2017-2019/2019_chem_preqaqc_BATCH-SBU_Mohawk_complete_2020-03-26.csv"))

# There appears to be no dissolved (D) fractions in 2017. R detects cols with "T" as logical (TRUE/FALSE) so these col types needed to be specified.

```

Bind SAMPLE, RESULT, and BATCH files by year.
```{r}

sample.all <- bind_rows(SAMPLE.2017, SAMPLE.2018, SAMPLE.2019)
result.all <- bind_rows(RESULT.2017, RESULT.2018, RESULT.2019)
batch.all <- bind_rows(BATCH.2017, BATCH.2018, BATCH.2019)

```

Test join by sys_sample_code and SDG
```{r}
result.all <- result.all %>% 
  rename(sample_delivery_group = lab_sdg)
test_join_sample.result <- left_join(sample.all, result.all, by = c("sys_sample_code", "sample_delivery_group"))

# CHECKS OUT OKAY. Same number of records created in joined table as in RESULT table.
```

Reformat date fields and headers, add EVENT ID field, add other blank fields
```{r}

sample.all.form <- sample.all %>% 
    rename_all(toupper) %>% 
    mutate(SAMPLE_DATE = as.POSIXct(SAMPLE_DATE, format = "%m/%d/%Y %H:%M:%S" )) %>% 
    mutate(SAMPLE_RECEIPT_DATE = as.Date(SAMPLE_RECEIPT_DATE, format = "%m/%d/%Y")) %>% 
    rename(SYS_SAMPLE_CDE = SYS_SAMPLE_CODE, SAMPLE_MATRIX_CDE = SAMPLE_MATRIX_CODE, 
           SAMPLE_TYPE_CDE = SAMPLE_TYPE_CODE, PARENT_SAMPLE_CDE = PARENT_SAMPLE_CODE, 
           SAMPLE_DEL_GRP = SAMPLE_DELIVERY_GROUP) %>% 
    mutate(SAMPLE_METHOD = "") %>% 
    rename_all(function(x) paste0("CHS_", x)) %>% 
    mutate(CHEM_HISTORY_SAMPLE_ID = "", CREATE_DATE = "", END_DATE = "", 
           UPDATE_DATE = "", UPDATED_BY_GUID = "") %>% 
    mutate(EVENT_ID_DATE = strftime(CHS_SAMPLE_DATE, "%Y%m%d")) %>% 
    mutate(EVENT_SMAS_ID = paste0(CHS_SITE_ID,"_",EVENT_ID_DATE))
 
# Left off here

result.all.form <- result.all %>% 
    rename_all(toupper) %>% 
    mutate(PARAMETER_ID = "") %>% 
    mutate(ANALYSIS_DATE = as.POSIXct(ANALYSIS_DATE, format = "%m/%d/%Y %H:%M:%S" )) %>% 
    mutate(CHEM_HISTORY_RESULT_ID = "", CHEM_HISTORY_SAMPLE_ID = "", CREATE_DATE = "", END_DATE = "", 
           UPDATE_DATE = "", UPDATED_BY_GUID = "") %>% 
    select(CHEM_HISTORY_RESULT_ID, CHEM_HISTORY_SAMPLE_ID, everything())

batch.all.form <- batch.all %>% 
    rename_all(toupper) %>% 
    mutate(CHEM_HISTORY_BATCH_ID = "", CHEM_HISTORY_SAMPLE_ID = "", CREATE_DATE = "", END_DATE = "", 
           UPDATE_DATE = "", UPDATED_BY_GUID = "") %>% 
    select(CHEM_HISTORY_BATCH_ID, CHEM_HISTORY_SAMPLE_ID, everything())


```

Select final headers as per ITS data model
```{r}
# SAMPLE table

  # LOOK INTO DROPPED FIELDS AND SEE IF WE'RE LOSING ANYTHING

sample.all.FINAL <- sample.all.form %>% 
    select(CHEM_HISTORY_SAMPLE_ID, EVENT_SMAS_ID, CHS_SITE_ID_CORR_IND, CHS_DATA_PROVIDER, CHS_SYS_SAMPLE_CDE, 
           CHS_SAMPLE_NAME, CHS_SAMPLE_MATRIX_CDE, CHS_DEC_SAMPLE_TYPE, CHS_SAMPLE_TYPE_CDE, CHS_SAMPLE_SOURCE, 
           CHS_PARENT_SAMPLE_CDE, CHS_SAMPLE_DEL_GRP, CHS_SAMPLE_DATE, CHS_CHAIN_OF_CUSTODY, CHS_SAMPLE_RECEIPT_DATE,
           CHS_SAMPLE_METHOD, CHS_SAMPLER, CHS_SAMPLING_COMPANY_CODE, CHS_COMMENT, CREATE_DATE, END_DATE, UPDATE_DATE, 
           UPDATED_BY_GUID)


# BATCH table
  # remove column number field (it's blank)
```


```{r}

```

