---
title: "compile_2022_results"
output: html_document
params:
  user: kareynol
---


```{r Load in libs, set project dirs}
library(tidyverse)

root.dir <- rprojroot::find_root("chem_hist_cleaning.Rproj")
target.dir <- file.path(root.dir, "data", "2023")#gavin already ran this so I can use to to adjust the flags based on Jason's manual review
qaqc_dir <- "C:/Users/kareynol/New York State Office of Information Technology Services/BWAM - ALS/2022/raw_all_flags_pre_review"
datamod.dir <- "C:/Users/kareynol/New York State Office of Information Technology Services/SMAS - Streams Data Modernization/Cleaned Files"

```

Import sample and result files exported from Chem_raw_processing.Rproj
```{r Import data}

# sample.all_1 <- read.csv(file.path(target.dir, "2021_chem_preqaqc_SAMPLE-peer_2_2023-02-27.csv"), stringsAsFactors = FALSE)
# 
# result.all_2 <- read.csv(file.path(target.dir, "2021_chem_preqaqc_RESULT-peers_2022-04-07.csv"), stringsAsFactors = FALSE,
#                        colClasses = c(fraction="character")
# )

result_filenames <- list.files(target.dir, pattern="^2022_chem_preqaqc_RESULT", full.names=TRUE)
result_list<- lapply(result_filenames, read.csv)
result_filenames_short<-list.files(target.dir, pattern="^2022_chem_preqaqc_RESULT", full.names=FALSE)

names(result_list)<-result_filenames_short
result.all<-plyr::ldply(result_list, rbind)


sample_filenames <- list.files(target.dir, pattern="^2022_chem_preqaqc_SAMPLE", full.names=TRUE)
sample_list<- lapply(sample_filenames, read.csv)
sample_filenames_short<-list.files(target.dir, pattern="^2022_chem_preqaqc_SAMPLE", full.names=FALSE)

names(sample_list)<-sample_filenames_short
sample.all<-plyr::ldply(sample_list, rbind)

sample.all<-sample.all %>% 
  distinct()

result.all<-result.all %>% 
  rename(sample_delivery_group = lab_sdg) %>% 
  distinct()

```

Test join by sys_sample_code and SDG
```{r Initial join test}
test_join_sample.result <- full_join(sample.all, result.all, by = c("sys_sample_code", "sample_delivery_group"))
test_join_sample.result2<-merge(sample.all,result.all, by = c("sys_sample_code",
                                                              "sample_delivery_group"),
                                all.y = TRUE)
#5/30/23 does not match, troubleshooting below
rm(test_join_sample.result,test_join_sample.result2)
```


```{r troubleshoot by project}
sample.all$.id<-gsub("SAMPLE","",sample.all$.id)
result.all$.id<-gsub("RESULT","",result.all$.id)

list_projects<-unique(sample.all$.id)

joined_list<-list()
for(i in list_projects){
  temp_result<-result.all %>% 
    filter(.id %in% i)
  nrow(temp_result)
  temp_sample<-sample.all %>% 
    filter(.id %in% i)
  temp_join<-full_join(temp_result,temp_sample,
                       by = c("sys_sample_code", "sample_delivery_group"))
  joined_list[[i]] <-temp_join
  if(nrow(temp_join) > nrow(temp_result)){
    print(i)
    print("Records in project result in extra matches")}
}

#Troubleshoot - ribs routine resulted in 3 extra records; fixed on 5/31
temp_sample$match<-paste(temp_sample$sys_sample_code,
                         temp_sample$sample_delivery_group)

temp_result$match<-paste(temp_result$sys_sample_code,
                         temp_result$sample_delivery_group)
temp_join$match<-paste(temp_join$sys_sample_code,
                         temp_join$sample_delivery_group)


check<-setdiff(temp_join$match,temp_result$match)
#KAR 5/30/23 fixed the sdg disagreement

joined_all<-plyr::ldply(joined_list, rbind)

joined_all<-joined_all %>% 
  select(sys_sample_code,
           sample_delivery_group,
           chemical_name,
           validator_qualifiers,
           everything())
#rm(test_join_sample.result,test_join_sample.result2,temp_join,temp_sample,temp_result)

```


```{r Initial join test 2}

#fix fecal coliform
#fix the fecal coliform names
result.all<-result.all %>% 
  mutate(chemical_name=case_when(
    chemical_name %in% "COLIFORM, FECAL"~"FECAL COLIFORM",
    TRUE~chemical_name
  ))
```

Import and bind flags from QAQC output files
```{r Import QAQC flags}
# Import all qaqc output files in subdir and bind together as a dataframe
#setwd(qaqc_dir) # Must run whole chunk for this to work
# qaqc.output.bound <- list.files(path = qaqc_dir, pattern = "*qaqc*.csv") %>%
#   map_df(~read_csv(.,  col_types = cols(fraction = col_character()))) %>%
#   mutate(chemical_name = tolower(chemical_name))
# 

qaqc_filenames <- list.files(qaqc_dir, pattern="^chem_qaqc_", full.names=TRUE)
qaqc_list<- lapply(qaqc_filenames, read.csv)
qaqc_filenames_short<-list.files(qaqc_dir, pattern="^chem_qaqc_", full.names=FALSE)

names(qaqc_list)<-qaqc_filenames_short
qaqc.all<-plyr::ldply(qaqc_list, rbind)

qaqc.all<-qaqc.all %>% 
   mutate(chemical_name = tolower(chemical_name))

qaqc.output.bound<-qaqc.all

qaqc.output.bound<-qaqc.output.bound %>% 
  select(sys_sample_code,
         sample_delivery_group,
         chemical_name,
         validator_qualifiers,
         everything()
  )

```


```{r adjust-flags-accuracy}

#accuracy adjustment
qa_mod1<-qaqc.output.bound %>% 
  #accuracy flags
  mutate(#BWRM
    validator_qualifiers=case_when(
      sample_delivery_group=="R2208439" & chemical_name=="chloride (as cl)"& sys_sample_code != "15-HACK_E-1.1-09072022-W"~"A",
      sample_delivery_group=="R2210399" & chemical_name=="chloride (as cl)"& sys_sample_code != "13-BOZN-1.4-10272022-W"~"A",
      sample_delivery_group=="R2207977" & chemical_name=="nitrogen, ammonia (as n)"& sys_sample_code != "15-HACK_W-1.4-08242022-W"~"A",
      #HREP_MUSS
      sample_delivery_group=="R2208952" & chemical_name=="mercury"~"A",
      #otisco
      sample_delivery_group=="R2205757" & chemical_name=="chloride (as cl)"~"A",
      #PWS year 2
      sample_delivery_group=="R2205112" & chemical_name=="aluminum"~"A",
      sample_delivery_group=="R2204940" & chemical_name=="nitrate+nitrite as nitrogen"~"A",
      #PWS year 1
      sample_delivery_group=="R2207425" & chemical_name=="chloride (as cl)"&
        sys_sample_code == "13-SAWK-0.8-08092022-W"~"R",
      sample_delivery_group=="R2207425" & chemical_name=="phosphorus, total (as p)"&
        sys_sample_code == "13-FDRY-0.4-07062022-W"~"R",
      #Routine
      sample_delivery_group=="R2207596" & chemical_name=="chloride (as cl)"~"J-",
      sample_delivery_group=="R2207634" & chemical_name=="chloride (as cl)"~"A",
      sample_delivery_group=="R2207914" & chemical_name=="chloride (as cl)"~"A",
      sample_delivery_group=="R2205393" & chemical_name=="nitrate+nitrite as nitrogen"~"J-",
     sample_delivery_group=="R2205397" & chemical_name=="nitrate+nitrite as nitrogen"~"J-",
     sample_delivery_group=="R2205399" & chemical_name=="nitrate+nitrite as nitrogen"~"J-",
     sample_delivery_group=="R2205417" & chemical_name=="nitrate+nitrite as nitrogen"~"J+",
     sample_delivery_group=="R2205417" & chemical_name=="phosphorus, total (as p)"~"J+",
     sample_delivery_group=="R2203244" & chemical_name=="sulfate (as so4)"~"J+",
     sample_delivery_group=="R2203214" & chemical_name=="mercury"~"A",
     sample_delivery_group=="R2205398" & chemical_name=="mercury"~"A",
     sample_delivery_group=="R2210007" & chemical_name=="mercury"~"J",
     #Screening
     sample_delivery_group=="R2206767" & chemical_name=="1-bromo-4-fluorobenzene bromofluorobenzene)"|
       chemical_name=="1,2-dichloroethane-d4"|
       chemical_name=="tetrahydrofuran-d8 (sur)"|
       chemical_name=="1,2-dichloroethane-d4"|
       chemical_name=="toluene-d8"|
       chemical_name=="tetrahydrofuran-d8 (sur)"~"A",
     sample_delivery_group=="R2208148" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sample_delivery_group=="R2208148" & chemical_name=="zinc" & sys_sample_code != "22S0118"~"A",
     sample_delivery_group=="R2208148" & chemical_name=="zinc" & sys_sample_code != "22S0118"~"A",
     sample_delivery_group=="R2208149" & chemical_name=="chloride (as cl)"~"J-",
     sample_delivery_group=="R2208150" & chemical_name=="chloride (as cl)"~"A",
     sample_delivery_group=="R2206628" & chemical_name=="chloride (as cl)"~"A",
     sample_delivery_group=="R2206629" & chemical_name=="chloride (as cl)"~"A",
     sample_delivery_group=="R2208233" & chemical_name=="chloride (as cl)"~"A",
    
      
      TRUE~validator_qualifiers)) %>% 
           ##########################################################
         #update the flag narrative
mutate(#BWRM
  interpreted_qualifiers=case_when(
    sample_delivery_group=="R2208439" & chemical_name=="chloride (as cl)" & sys_sample_code != "15-HACK_E-1.1-09072022-W"~"", 
    sample_delivery_group=="R2210399" & chemical_name=="chloride (as cl)"& sys_sample_code != "13-BOZN-1.4-10272022-W"~"",
    sample_delivery_group=="R2207977" & chemical_name=="nitrogen, ammonia (as n)"& sys_sample_code != "15-HACK_W-1.4-08242022-W"~"",
    #HREP
    sample_delivery_group=="R2208952" & chemical_name=="mercury"~"",
    #otisco
    sample_delivery_group=="R2205757" & chemical_name=="chloride (as cl)"~"",
    sample_delivery_group=="R2205112" & chemical_name=="aluminum"~"",
    sample_delivery_group=="R2204940" & chemical_name=="nitrate+nitrite as nitrogen"~"",
    #pws year 1
    sample_delivery_group=="R2207425" & chemical_name=="chloride (as cl)"&
        sys_sample_code == "13-SAWK-0.8-08092022-W"~"Accuracy error",
    sample_delivery_group=="R2207425" & chemical_name=="phosphorus, total (as p)"&
        sys_sample_code == "13-FDRY-0.4-07062022-W"~"Accuracy error",
    #Routine
    sample_delivery_group=="R2207596" & chemical_name=="chloride (as cl)"~"Accuracy error, results biased low",
    sample_delivery_group=="R2207634" & chemical_name=="chloride (as cl)"~"",
    sample_delivery_group=="R2207634" & chemical_name=="chloride (as cl)"~"",
    sample_delivery_group=="R2207914" & chemical_name=="chloride (as cl)"~"",
    sample_delivery_group=="R2205393" & chemical_name=="nitrate+nitrite as nitrogen"~"Accuracy error, results biased low",
    sample_delivery_group=="R2205397" & chemical_name=="nitrate+nitrite as nitrogen"~"Accuracy error, results biased low",
    sample_delivery_group=="R2205399" & chemical_name=="nitrate+nitrite as nitrogen"~"Accuracy error, results biased low",
    sample_delivery_group=="R2205417" & chemical_name=="phosphorus, total (as p)"~"Accuracy error, results biased high",
    sample_delivery_group=="R2203244" & chemical_name=="sulfate (as so4)"~"Accuracy error, results biased high",
    sample_delivery_group=="R2203214" & chemical_name=="mercury"~"",
    sample_delivery_group=="R2210007" & chemical_name=="mercury"~"ESTIMATED CONCENTRATION - STILL SUITABLE FOR MOST DATA USES",
    #Screening
    sample_delivery_group=="R2206767" & chemical_name=="1-bromo-4-fluorobenzene bromofluorobenzene)"|
       chemical_name=="1,2-dichloroethane-d4"|
       chemical_name=="tetrahydrofuran-d8 (sur)"|
       chemical_name=="1,2-dichloroethane-d4"|
       chemical_name=="toluene-d8"|
       chemical_name=="tetrahydrofuran-d8 (sur)" ~"",
    sample_delivery_group=="R2208148" & chemical_name=="zinc" & sys_sample_code != "22S0118"~"",
    sample_delivery_group=="R2208149" & chemical_name=="chloride (as cl)"~"Accuracy error, results biased low",
    sample_delivery_group=="R2208150" & chemical_name=="chloride (as cl)"~"",
    sample_delivery_group=="R2206628" & chemical_name=="chloride (as cl)"~"",
    sample_delivery_group=="R2206629" & chemical_name=="chloride (as cl)"~"",
    sample_delivery_group=="R2208233" & chemical_name=="chloride (as cl)"~"",
    
     
    TRUE~interpreted_qualifiers)) %>% 
  mutate(chemical_name=case_when(
    chemical_name == "coliform, fecal"~"fecal coliform",
    
    TRUE~chemical_name))

```

```{r adjust-flags-precision }
qa_mod2<-qa_mod1 %>% 
  #accuracy flags
  mutate(validator_qualifiers=case_when(#BWRM
    sample_delivery_group=="R2210399" & chemical_name=="nitrogen, kjeldahl, total"~"A",
    sample_delivery_group=="R2210399" & chemical_name=="turbidity"~"A",
    sample_delivery_group=="R2210272" & chemical_name=="turbidity"~"A",
    #specific to hansgroot2022
    project_name=="hansgroot_2022" & validator_qualifiers=="R"~"A",
    #HREP
    sample_delivery_group=="R2207427" & chemical_name=="nitrate+nitrite as nitrogen"~"J",
    sample_delivery_group=="R2207427" & chemical_name=="nitrogen"~"J",
    sample_delivery_group=="R2207427" & chemical_name=="turbidity"~"J",
    #otisco
    sample_delivery_group=="R2205757" & chemical_name=="nitrogen, ammonia (as n)"~"J+",
    #PWS year 1
      sample_delivery_group=="R2209024" & chemical_name=="manganese"&
        sys_sample_code == "09-GRFD-0.3-09212022-W"~"R",
      sample_delivery_group=="R2209024" & chemical_name=="nitrogen, ammonia (as n)"&
        sys_sample_code == "09-GRFD-0.3-09212022-W"~"R",
      sample_delivery_group=="R2207425" & chemical_name=="carbon, dissolved organic (doc)"&
        sys_sample_code == "13-CROI-10.1-08092022-W"~"R",
      sample_delivery_group=="R2207425" & chemical_name=="nitrogen, kjeldahl, total"&
        sys_sample_code == "13-CROI-10.1-08092022-W"~"R",
    #Routine
    sample_delivery_group=="R2205417" & chemical_name=="nitrogen, kjeldahl, total"~"A",
    sample_delivery_group=="R2205419" & chemical_name=="iron"| chemical_name =="manganese" ~"R",
    sample_delivery_group=="R2205419" & chemical_name=="aluminum"| chemical_name =="lead" ~"R",
    sample_delivery_group=="R2205393" & chemical_name=="turbidity"~"A",
    sample_delivery_group=="R2205397" & chemical_name=="calcium"~"A",
    sample_delivery_group=="R2210007" & chemical_name=="mercury"~"J",
    sample_delivery_group=="R2207914" & chemical_name=="nitrogen, kjeldahl, total" | chemical_name=="nitrogen" ~"R",
    
    
    
                                        TRUE~validator_qualifiers
                                        )) %>% 
         ############################################fix the interp  
  mutate(interpreted_qualifiers=case_when(
    sample_delivery_group=="R2210399" & chemical_name=="nitrogen, kjeldahl, total"~"",
    sample_delivery_group=="R2210399" & chemical_name=="turbidity"~"",
    sample_delivery_group=="R2210272" & chemical_name=="turbidity"~"",
    sample_delivery_group=="R2207427" & chemical_name=="tnitrate+nitrite as nitrogen"~"ESTIMATED CONCENTRATION - STILL SUITABLE FOR MOST DATA USES",
    sample_delivery_group=="R2207427" & chemical_name=="nitrogen"~"ESTIMATED CONCENTRATION - STILL SUITABLE FOR MOST DATA USES",
    sample_delivery_group=="R2207427" & chemical_name=="turbidity"~"ESTIMATED CONCENTRATION - STILL SUITABLE FOR MOST DATA USES",
    #otisco
    sample_delivery_group=="R2205757" & chemical_name=="nitrogen, ammonia (as n)"~"ESTIMATED CONCENTRATION - STILL SUITABLE FOR MOST DATA USES",
    #PWS year 1
    sample_delivery_group=="R2209024" & chemical_name=="manganese"&
        sys_sample_code == "09-GRFD-0.3-09212022-W"~"Accuracy error",
    sample_delivery_group=="R2209024" & chemical_name=="nitrogen, ammonia (as n)"&
        sys_sample_code == "09-GRFD-0.3-09212022-W"~"Accuracy error",
    sample_delivery_group=="R2207425" & chemical_name=="carbon, dissolved organic (doc)"&
        sys_sample_code == "13-CROI-10.1-08092022-W"~"Accuracy error",
    sample_delivery_group=="R2207425" & chemical_name=="nitrogen, kjeldahl, total"&
        sys_sample_code == "13-CROI-10.1-08092022-W"~"Accuracy error",
    sample_delivery_group=="R2205417" & chemical_name=="nitrogen, kjeldahl, total"~"",
    sample_delivery_group=="R2205419" & chemical_name=="iron"| chemical_name =="manganese" ~"Accuracy error",
    sample_delivery_group=="R2205419" & chemical_name=="aluminum"| chemical_name =="lead" ~"Accuracy error",
    sample_delivery_group=="R2205393" & chemical_name=="turbidity"~"",
    sample_delivery_group=="R2205397" & chemical_name=="calcium"~"A",
    sample_delivery_group=="R2210007" & chemical_name=="mercury"~"ESTIMATED CONCENTRATION - STILL SUITABLE FOR MOST DATA USES",
    sample_delivery_group=="R2207914" & chemical_name=="nitrogen, kjeldahl, total" | chemical_name=="nitrogen" ~"Accuracy error",
    
    
                                        TRUE~interpreted_qualifiers
                                        ))

```

```{r adjust-flags-eb}
qa_mod3<-qa_mod2 %>% 
  #equipment_blank flags
  mutate(validator_qualifiers=case_when(#BWRM
       sample_delivery_group=="R2204802" & chemical_name=="nitrogen, kjeldahl, total"~"J+",
       sample_delivery_group=="R2204802" & chemical_name=="turbidity"~"J+",
       sample_delivery_group=="R2207975" & chemical_name=="nitrogen"~"A",
       sample_delivery_group=="R2207975" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       sample_delivery_group=="R2207975" & chemical_name=="manganese"~"A",
       sample_delivery_group=="R2207977" & chemical_name=="zinc"~"R",
       sample_delivery_group=="R2207977" & chemical_name=="nitrogen, ammonia (as n)"~"A",
       sample_delivery_group=="R2207977" & chemical_name=="nitrate+nitrite as nitrogen"~"A",
       sample_delivery_group=="R2207977" & chemical_name=="nitrogen"~"A",
       sample_delivery_group=="R2207977" & chemical_name=="nitrogen, kjeldahl, total"~"J+",
       sample_delivery_group=="R2207977" & chemical_name=="turbidity"~"J+",
       sample_delivery_group=="R2208441" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       sample_delivery_group=="R2208441" & chemical_name=="turbidity"~"A",
       sys_sample_code == "13-NORM-21.6-09072022-W" & chemical_name == "zinc"~"J+",
       sample_delivery_group=="R2208443" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       sample_delivery_group=="R2209300" & chemical_name=="nitrogen"~"A",
       sample_delivery_group=="R2209300" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       sample_delivery_group=="R2209300" & chemical_name=="total dissolved solids (residue, filterable)"~"R",
       sample_delivery_group=="R2210272" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       sample_delivery_group=="R2210399" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       #HREP
       sample_delivery_group=="R2207428" & chemical_name=="mercury"& validator_qualifiers != "U"~"J+",
       sample_delivery_group=="R2207427" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       sample_delivery_group=="R2206451" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       sample_delivery_group=="R2208773" & chemical_name=="nitrogen, kjeldahl, total"~"R",
       sample_delivery_group=="R2208773" & chemical_name=="nitrogen"~"R",
       sample_delivery_group=="R2208773" & chemical_name=="turbidity"~"A",
       #otisco
       sample_delivery_group=="R2205757" & chemical_name=="nitrogen, ammonia (as n)"~"J+",
       sample_delivery_group=="R2206761" & chemical_name=="aluminum"~"R",
       sample_delivery_group=="R2207812" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       sample_delivery_group=="R2207812" & chemical_name=="turbidity"~"A",
       #PWS year 2
       sample_delivery_group=="R2204805" & chemical_name=="nitrate+nitrite as nitrogen"~"A",
       sample_delivery_group=="R2204940" & chemical_name=="turbidity"~"A",
       sample_delivery_group=="R2205112" & chemical_name=="nitrogen, kjeldahl, total"~"J+",
       sample_delivery_group=="R2205112" & chemical_name=="nitrogen"~"J+",
       sample_delivery_group=="R2206187" & chemical_name=="chlorophyll a"~"A",
       sample_delivery_group=="R2206945" & chemical_name=="nitrogen, ammonia (as n)"~"A",
       sample_delivery_group=="R2206945" & chemical_name=="turbidity"~"A",
       sample_delivery_group=="R2209077" & chemical_name=="nitrate+nitrite as nitrogen"~"A",
       #PWS year 1
       sample_delivery_group=="R2206175" & chemical_name=="nitrogen, ammonia (as n)"~"A",
       sample_delivery_group=="R2206175" & chemical_name=="orthophosphate as phosphorus, dissolved"~"R",
       sample_delivery_group=="R2207423" & chemical_name=="nitrogen, kjeldahl, total"~"R",
       sample_delivery_group=="R2207423" & chemical_name=="nitrogen"~"R",
       sample_delivery_group=="R2207423" & chemical_name=="turbidity"~"A",
       sample_delivery_group=="R2207425" & chemical_name=="nitrogen, kjeldahl, total"~"R",
       sample_delivery_group=="R2207425" & chemical_name=="nitrogen"~"R",
       sample_delivery_group=="R2209079" & chemical_name=="total dissolved solids (residue, filterable)"~"A",
       sample_delivery_group=="R2209099" & chemical_name=="turbidity"~"A",
       #Sus bjc
       sample_delivery_group=="R2206344" & chemical_name=="nitrogen, kjeldahl, total"~"A",
       #routine
       sample_delivery_group=="R2207613" & sys_sample_code=="17-BRNX-5.6-08152022-W" | sys_sample_code=="17-BRNX-5.6-08152022-EB"| sys_sample_code=="17-BRNX-5.6-08152022-SEQ" ~"R",
       sample_delivery_group=="R2205419" & chemical_name=="chlorophyll a"~ "A",
       sample_delivery_group=="R2205419" & chemical_name=="nitrate+nitrite as nitrogen"~ "A",
       sample_delivery_group=="R2205397" & chemical_name=="nitrate+nitrite as nitrogen"~ "A",
       sample_delivery_group=="R2205397" & chemical_name=="nitrogen, kjeldahl, total"~ "A",
       sample_delivery_group=="R2205397" & chemical_name=="turbidity"~ "J+",
       sample_delivery_group=="R2203213" & chemical_name=="nitrate+nitrite as nitrogen"~ "A",
       sample_delivery_group=="R2203213" & chemical_name=="nitrogen, ammonia (as n)"~ "J+",
       sample_delivery_group=="R2203213" & chemical_name=="nitrogen, kjeldahl, total"~ "J+",
       sample_delivery_group=="R2207914" & chemical_name=="nitrogen, ammonia (as n)"~ "J+",
       sample_delivery_group=="R2207914" & chemical_name=="nitrogen, kjeldahl, total" | chemical_name=="nitrogen"~ "R",
       sample_delivery_group=="R2207914" & chemical_name=="zinc"~ "J+",
       sample_delivery_group=="R2210006" & chemical_name=="nitrogen, kjeldahl, total"~"J+",
       sample_delivery_group=="R2203217" & chemical_name=="zinc"~"J",
       sample_delivery_group=="R2209947" & chemical_name=="nitrogen, kjeldahl, total"~"A",
      sample_delivery_group=="R2205417" & chemical_name=="aluminum"~"J+",
      sample_delivery_group=="R2209949" & chemical_name=="nitrate+nitrite as nitrogen"~"A",
     #screening
     sample_date=="2022-07-19" & chemical_name=="nitrogen, ammonia (as n)"~"J+",
     sample_delivery_group == "R2206627" & chemical_name=="phosphorus, total (as p)"~"A",
     sample_date=="2022-07-21" & chemical_name=="nitrogen, ammonia (as n)"|
       chemical_name =="nitrogen, kjeldahl, total"~"A",
     sample_delivery_group == "R2206627" & chemical_name=="turbidity"~"A",
     sample_delivery_group == "R2206628" & chemical_name=="nitrogen"|
        chemical_name =="nitrogen, ammonia (as n)" |
        chemical_name =="nitrogen, kjeldahl, total"|
        chemical_name =="phosphorus, total (as p)"~ "A",
     sample_delivery_group == "22S0056" & chemical_name=="turbidity"~"A",
     sys_sample_code =="22S0056"|
       sys_sample_code =="22S0055"|
       sys_sample_code ==" 22S0054"|
       sys_sample_code =="22S0053"|
       sys_sample_code =="22S0050"|
       sys_sample_code =="22S0052"|
       sys_sample_code =="22S0061" & chemical_name=="turbidity"~"J+",
     sample_delivery_group == "R2206628" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sys_sample_code =="22S0057"|
       sys_sample_code =="22S0058" & chemical_name=="nitrogen, kjeldahl, total"|
       chemical_name =="nitrogen"|
       chemical_name =="zinc"~"J+",
     sample_delivery_group == "R2206629" & chemical_name=="nitrogen, kjeldahl, total"~"A",
     sample_delivery_group == "R2206629" & chemical_name=="turbidity"~"A",
     sample_delivery_group == "R2206629" & chemical_name=="turbidity"~"A",
     sample_date=="2022-07-21" & chemical_name=="aluminum" |
       chemical_name =="iron"~"J+",
     sample_delivery_group == "R2206629" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sample_delivery_group == "R2206629" & chemical_name=="nitrogen, kjeldahl, total"| chemical_name =="nitrogen"~"J+",
     sample_delivery_group == "R2206630" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sample_delivery_group == "R2206630" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sample_date=="2022-07-20" & chemical_name=="turbidity"~"J+",
     sample_delivery_group=="R2206630" & chemical_name=="turbidity"~"A",
     sample_delivery_group=="R2206702" & chemical_name=="carbon, dissolved organic (doc)"~"A",
     sample_delivery_group=="R2206702" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sample_delivery_group=="R2207022" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sample_date=="2022-07-28" & chemical_name=="copper"|
       chemical_name=="zinc"~"J+",
     sys_sample_code =="22S0118"|
       sys_sample_code =="22S0121"|
       sys_sample_code =="22S0122"| sys_sample_code =="22S0123"& chemical_name=="nitrogen, kjeldahl, total"|
       chemical_name =="nitrogen"~"J+",
     sample_delivery_group=="R2208148" & chemical_name=="turbidity"~"A",
     sys_sample_code =="22S0208"|
       sys_sample_code =="22S0209"|
       sys_sample_code =="22S0210"| 
       sys_sample_code =="22S0211"|
       sys_sample_code =="22S0212"|
       sys_sample_code =="22S0213"|
       sys_sample_code =="22S0271" & chemical_name=="nitrogen, kjeldahl, total"|
       chemical_name =="nitrogen"~"J+",
     sample_date=="2022-09-13" & chemical_name=="zinc"~"J+",
     sample_date=="2022-09-15" & chemical_name=="carbon, dissolved organic (doc)"~"J+",
     sample_delivery_group=="R2208666" & chemical_name=="nitrogen, kjeldahl, total"~"A",
     sample_delivery_group=="R2208667" & chemical_name=="nitrogen, kjeldahl, total"| chemical_name =="nitrogen, nitrite"~"A",
     
     
    TRUE~validator_qualifiers)) %>% 
  #####################################fix flag narrative#######################
    mutate(interpreted_qualifiers=case_when(
      sample_delivery_group=="R2204802" & chemical_name=="nitrogen, kjeldahl, total"~"Equipment Blank error; results may be biased high",
      sample_delivery_group=="R2204802" & chemical_name=="turbidity"~"Equipment Blank error; results may be biased high",
      sample_delivery_group=="R2207975" & chemical_name=="nitrogen"~"",
      sample_delivery_group=="R2207975" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2207975" & chemical_name=="manganese"~"",
      sample_delivery_group=="R2207977" & chemical_name=="zinc"~"Equipment Blank error",
      sample_delivery_group=="R2207977" & chemical_name=="nitrogen, ammonia (as n)"~"",
      sample_delivery_group=="R2207977" & chemical_name=="nitrate+nitrite as nitrogen"~"",
      sample_delivery_group=="R2207977" & chemical_name=="nitrogen"~"",
      sample_delivery_group=="R2207977" & chemical_name=="nitrogen, kjeldahl, total"~"Equipment Blank error; results may be biased high",
      sample_delivery_group=="R2207977" & chemical_name=="turbidity"~"Equipment Blank error; results may be biased high",
      sample_delivery_group=="R2208441" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2208441" & chemical_name=="turbidity"~"",
      sys_sample_code == "13-NORM-21.6-09072022-W" & chemical_name == "zinc"~"Equipment Blank error; results may be biased high",
      sample_delivery_group=="R2208443" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2209300" & chemical_name=="nitrogen"~"",
      sample_delivery_group=="R2209300" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2209300" & chemical_name=="total dissolved solids (residue, filterable)"~"Equipment Blank error",
      sample_delivery_group=="R2210272" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2210399" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2207428" & chemical_name=="mercury"& validator_qualifiers != "U"~"Equipment Blank error, results may be biased high",
      sample_delivery_group=="R2207427" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2206451" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2208773" & chemical_name=="nitrogen, kjeldahl, total"~"Equipment Blank error",
      sample_delivery_group=="R2208773" & chemical_name=="nitrogen"~"Equipment Blank error",
      sample_delivery_group=="R2208773" & chemical_name=="turbidity"~"",
      #otisco
      sample_delivery_group=="R2205757" & chemical_name=="nitrogen, ammonia (as n)"~"Equipment Blank error,results estimated high",
      sample_delivery_group=="R2206761" & chemical_name=="aluminum"~"Equipment Blank error",
      sample_delivery_group=="R2207812" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2207812" & chemical_name=="turbidity"~"",
      #PWS year 2
      sample_delivery_group=="R2204805" & chemical_name=="nitrate+nitrite as nitrogen"~"A",
      sample_delivery_group=="R2204940" & chemical_name=="turbidity"~"",
      #PWS year 2
      sample_delivery_group=="R2205112" & chemical_name=="nitrogen, kjeldahl, total"~"Equipment Blank error; results estimated high",
      sample_delivery_group=="R2205112" & chemical_name=="nitrogen"~"Equipment Blank error; results estimated high",
      sample_delivery_group=="R2206187" & chemical_name=="chlorophyll a"~"",
      sample_delivery_group=="R2206945" & chemical_name=="nitrogen, ammonia (as n)"~"",
      sample_delivery_group=="R2206945" & chemical_name=="turbidity"~"",
      sample_delivery_group=="R2209077" & chemical_name=="nitrate+nitrite as nitrogen"~"",
      #PWS year 1
      sample_delivery_group=="R2206175" & chemical_name=="nitrogen, ammonia (as n)"~"",
      sample_delivery_group=="R2206175" & chemical_name=="orthophosphate as phosphorus, dissolved"~"Equipment Blank error",
      sample_delivery_group=="R2207423" & chemical_name=="nitrogen, kjeldahl, total"~"Equipment Blank error",
       sample_delivery_group=="R2207423" & chemical_name=="nitrogen"~"Equipment Blank error",
      sample_delivery_group=="R2207423" & chemical_name=="turbidity"~"",
      sample_delivery_group=="R2207425" & chemical_name=="nitrogen, kjeldahl, total"~"Equipment Blank error",
       sample_delivery_group=="R2207425" & chemical_name=="nitrogen"~"Equipment Blank error",
      sample_delivery_group=="R2209079" & chemical_name=="total dissolved solids (residue, filterable)"~"",
      sample_delivery_group=="R2209099" & chemical_name=="turbidity"~"A",
      #Sus bjc
      sample_delivery_group=="R2206344" & chemical_name=="nitrogen, kjeldahl, total"~"",
      #routine
      sample_delivery_group=="R2207613" & sys_sample_code=="17-BRNX-5.6-08152022-W" | sys_sample_code=="17-BRNX-5.6-08152022-EB"| sys_sample_code=="17-BRNX-5.6-08152022-SEQ" ~"Equipment Blank error",
      sample_delivery_group=="R2205393"~ "Equipment Blank error, results biased high",
      sample_delivery_group=="R2205419" & chemical_name=="chlorophyll a"~ "",
      sample_delivery_group=="R2205419" & chemical_name=="nitrate+nitrite as nitrogen"~ "",
      sample_delivery_group=="R2205397" & chemical_name=="nitrate+nitrite as nitrogen"~ "",
      sample_delivery_group=="R2205397" & chemical_name=="nitrogen, kjeldahl, total"~ "",
      sample_delivery_group=="R2205397" & chemical_name=="turbidity"~ "Equipment Blank error, results biased high",
      sample_delivery_group=="R2203213" & chemical_name=="nitrate+nitrite as nitrogen"~ "",
      sample_delivery_group=="R2203213" & chemical_name=="nitrogen, ammonia (as n)"~ "Equipment Blank error, results biased high",
      sample_delivery_group=="R2203213" & chemical_name=="nitrogen, kjeldahl, total"~ "Equipment Blank error, results biased high",
      sample_delivery_group=="R2207914" & chemical_name=="nitrogen, ammonia (as n)"~ "Equipment Blank error, results biased high",
      sample_delivery_group=="R2207914" & chemical_name=="nitrogen, kjeldahl, total" | chemical_name=="nitrogen"~ "Equipment Blank Error",
      sample_delivery_group=="R2207914" & chemical_name=="zinc"~ "Equipment Blank Error, results biased high",
      sample_delivery_group=="R2210006" & chemical_name=="nitrogen, kjeldahl, total"~"Equipment Blank Error, results biased high",
      sample_delivery_group=="R2203217" & chemical_name=="zinc"~"Equipment Blank error, results estimated",
      sample_delivery_group=="R2209947" & chemical_name=="nitrogen, kjeldahl, total"~"",
      sample_delivery_group=="R2205417" & chemical_name=="aluminum"~"Equipment Blank error, results biased high",
      sample_delivery_group=="R2209949" & chemical_name=="nitrate+nitrite as nitrogen"~"",
      #screening
      sample_date=="2022-07-19" & chemical_name=="nitrogen, ammonia (as n)"~"Equipment Blank error, results biased high",
      sample_delivery_group == "R2206627" & chemical_name=="phosphorus, total (as p)"~"",
      sample_date=="2022-07-21" & chemical_name=="nitrogen, ammonia (as n)"|
       chemical_name =="nitrogen, kjeldahl, total"~"",   
     sample_delivery_group == "R2206627" & chemical_name=="turbidity"~"",
     sample_delivery_group == "R2206628" & chemical_name=="nitrogen"|
        chemical_name =="nitrogen, ammonia (as n)" |
        chemical_name =="nitrogen, kjeldahl, total"|
        chemical_name =="phosphorus, total (as p)"~ "",
     sample_delivery_group == "R2206627" & chemical_name=="turbidity"~"",
     sys_sample_code =="22S0056"|
       sys_sample_code =="22S0055"|
       sys_sample_code ==" 22S0054"|
       sys_sample_code =="22S0053"|
       sys_sample_code =="22S0050"|
       sys_sample_code =="22S0052"|
       sys_sample_code =="22S0061" & chemical_name=="turbidity"~"Equipment Blank error, results biased high",
     sample_delivery_group == "R2206628" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sys_sample_code =="22S0057"|
       sys_sample_code =="22S0058" & chemical_name=="nitrogen, kjeldahl, total"|
       chemical_name =="nitrogen"|
       chemical_name =="zinc"~"Equipment Blank error, results biased high",
     sample_delivery_group == "R2206629" & chemical_name=="nitrogen, kjeldahl, total"~"",
     sample_delivery_group == "R2206629" & chemical_name=="turbidity"~"",
     sample_date=="2022-07-21" & chemical_name=="aluminum" |
       chemical_name =="iron"~"Equipment Blank error, results biased high",
     sample_delivery_group == "R2206629" & chemical_name=="nitrogen, ammonia (as n)"~"",
     sample_delivery_group == "R2206629" & chemical_name=="nitrogen, kjeldahl, total" | chemical_name =="nitrogen"~"Equipment Blank error, results biased high",
     sample_delivery_group == "R2206630" & chemical_name=="nitrogen, ammonia (as n)"~"",
     sample_date=="2022-07-20" & chemical_name=="turbidity"~"Equipment Blank error,results biased high",
     sample_delivery_group=="R2206630" & chemical_name=="turbidity"~"",
     sample_delivery_group=="R2206702" & chemical_name=="carbon, dissolved organic (doc)"~"",
     sample_delivery_group=="R2206702" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sample_delivery_group=="R2207022" & chemical_name=="nitrogen, ammonia (as n)"~"A",
     sample_date=="2022-07-28" & chemical_name=="copper"|
       chemical_name=="zinc"~"Equipment Blank error, results biased high",
     sys_sample_code =="22S0118"|
       sys_sample_code =="22S0121"|
       sys_sample_code =="22S0122"| sys_sample_code =="22S0123"& chemical_name=="nitrogen, kjeldahl, total"|
       chemical_name =="nitrogen"~"Equipment Blank error, results biased high",
     sample_delivery_group=="R2208148" & chemical_name=="turbidity"~"",
     sys_sample_code =="22S0208"|
       sys_sample_code =="22S0209"|
       sys_sample_code =="22S0210"| 
       sys_sample_code =="22S0211"|
       sys_sample_code =="22S0212"|
       sys_sample_code =="22S0213"|
       sys_sample_code =="22S0271" & chemical_name=="nitrogen, kjeldahl, total"|
       chemical_name =="nitrogen"~"Equipment Blank error, results biased high",
     sample_date=="2022-09-13" & chemical_name=="zinc"~"Equipment Blank error, results biased high",
     sample_date=="2022-09-15" & chemical_name=="carbon, dissolved organic (doc)"~"Equipment Blank error, results biased high",
     sample_delivery_group=="R2208666" & chemical_name=="nitrogen, kjeldahl, total"~"",
     sample_delivery_group=="R2208667" & chemical_name=="nitrogen, kjeldahl, total"| chemical_name =="nitrogen, nitrite"~"",
     
     TRUE~interpreted_qualifiers))
  

```


```{r adjust-flags-parameter-pairs}
qa_mod4<-qa_mod3 %>% 
    mutate(validator_qualifiers=case_when(#BWRM
      sys_sample_code=="13-NORM-21.6-10272022-W" & chemical_name=="nitrogen, nitrite"~"J",
      sys_sample_code=="13-BOZN-1.4-10272022-W" & chemical_name=="nitrogen, nitrite"~"J",
      #routine
      sample_delivery_group =="R2203244" & sys_sample_code=="01-BUFF-1.7-04122022-W" & chemical_name=="orthophosphate as phosphorus, dissolved"| chemical_name=="phosphorus, total (as p)"~"R",
      sample_delivery_group =="R2203286" & chemical_name=="orthophosphate as phosphorus, dissolved"~"A",
      
      
                                          TRUE~validator_qualifiers)) %>% 
  #############################interpreted flag adjustment ##################
  
  mutate(interpreted_qualifiers=case_when(#BWRM
    sys_sample_code=="13-NORM-21.6-10272022-W" & chemical_name=="nitrogen, nitrite"~"Estimated due to Precision error",
    sys_sample_code=="13-BOZN-1.4-10272022-W" & chemical_name=="nitrogen, nitrite"~"Estimated due to Precision error",
    #routine
    sample_delivery_group =="R2203244" & sys_sample_code=="01-BUFF-1.7-04122022-W" & chemical_name=="orthophosphate as phosphorus, dissolved"| chemical_name=="phosphorus, total (as p)"~"Precision error",
    sample_delivery_group =="R2203286" & chemical_name=="orthophosphate as phosphorus, dissolved"~"A",
                                          TRUE~interpreted_qualifiers))
                                            

```

```{r adjust-flags-holding_time}
qa_mod5<-qa_mod4 %>% 
    mutate(validator_qualifiers=case_when(
      #HREP
 sample_delivery_group=="R2206451" & chemical_name=="turbidity"~"J+",
 sample_delivery_group=="R2206451" & chemical_name=="orthophosphate as phosphorus, dissolved"~"J+",
 sample_delivery_group=="R2206451" & chemical_name=="nitrogen, nitrite"~"J+",
 #PWS year 2
 sample_delivery_group=="R2204805" & chemical_name=="nitrogen, nitrite"~"R",
 sample_delivery_group=="R2204805" & chemical_name=="nitrogen"~"R",
 #Sus bjc
 sample_delivery_group=="R2206344" & chemical_name=="nitrogen, nitrite"~"A",
 #routine
 sample_delivery_group=="R2205444" & chemical_name=="nitrogen, nitrite"
 |chemical_name=="orthophosphate as phosphorus, dissolved" |
  chemical_name=="turbidity" ~"J",
 sample_delivery_group=="R2209947" & chemical_name=="nitrogen, nitrite"
 |chemical_name=="orthophosphate as phosphorus, dissolved" |
  chemical_name=="turbidity" ~"J",
 #Screening
 sample_delivery_group=="R2206767" & chemical_name=="1-bromo-4-fluorobenzene bromofluorobenzene)"|
   chemical_name=="1,1-dichloroethane" |
   chemical_name=="1,1-dichloroethane d4"|
   chemical_name=="1,2,3-trichloropropane"|
   chemical_name=="bromomethane" |
   chemical_name=="chlorodifluoromethane"|
   chemical_name=="chloromethane"|
   chemical_name =="toluene-d8"|
   chemical_name =="tetrahydrofuran-d8 (sur)"|
   chemical_name =="1,4-dioxane (p-dioxane)"~"A",
 sample_delivery_group=="R2208233" & chemical_name=="NO2"|
   chemical_name == "nitrogen, nitrate (as n)"~"R",
 sample_delivery_group=="R2208233" & chemical_name == "turbidity"~"J",
 
 

TRUE~validator_qualifiers)) %>% 
mutate(interpreted_qualifiers=case_when(
  #HREP
   sample_delivery_group=="R2206451" & chemical_name=="turbidity"~"Holding Time error, estimated high due to Holding time exceedance",
    sample_delivery_group=="R2206451" & chemical_name=="orthophosphate as phosphorus, dissolved"~"Holding Time error, estimated high due to Holding time exceedance",
 sample_delivery_group=="R2206451" & chemical_name=="nitrogen, nitrite"~"Holding Time error, estimated high due to Holding time exceedance",
 #PWS year 2
sample_delivery_group=="R2204805" & chemical_name=="nitrogen, nitrite"~"Holding Time error",
sample_delivery_group=="R2204805" & chemical_name=="nitrogen"~"Holding Time error",
#Sus bjc
sample_delivery_group=="R2206344" & chemical_name=="nitrogen, nitrite"~"",
#routine
 sample_delivery_group=="R2205444" & chemical_name=="nitrogen, nitrite"
 |chemical_name=="orthophosphate as phosphorus, dissolved" |
  chemical_name=="turbidity" ~ "Estimated due to Holding time exceedance",
sample_delivery_group=="R2209947" & chemical_name=="nitrogen, nitrite"
 |chemical_name=="orthophosphate as phosphorus, dissolved" |
  chemical_name=="turbidity" ~"Estimated due to Holding time exceedance",
#screening
 sample_delivery_group=="R2206767" & chemical_name=="1-bromo-4-fluorobenzene bromofluorobenzene)"|
   chemical_name=="1,1-dichloroethane" |
   chemical_name=="1,1-dichloroethane d4"|
   chemical_name=="1,2,3-trichloropropane"|
   chemical_name=="bromomethane" |
   chemical_name=="chlorodifluoromethane"|
   chemical_name=="chloromethane"|
   chemical_name =="toluene-d8"|
   chemical_name =="tetrahydrofuran-d8 (sur)"|
   chemical_name =="1,4-dioxane (p-dioxane)"~"",
sample_delivery_group=="R2208233" & chemical_name=="NO2"|
   chemical_name == "nitrogen, nitrate (as n)"~"Holding time error",
 sample_delivery_group=="R2208233" & chemical_name == "turbidity"~"Estimated due to Holding time exceedance",
 

  TRUE~interpreted_qualifiers))
                                            

```



```{r validation-flag-fraction-fix}
# Select only fields needed to join to results table and mark all as validated 
qaqc.output.bound <- qa_mod5 %>%
  select(project_name, sys_sample_code, sample_delivery_group, chemical_name, fraction, validator_qualifiers, interpreted_qualifiers, qaqc_date,result_value) %>%
  mutate(validated_yn = "Y") %>%
  rename(VALIDATOR_QUAL_EXPLN = interpreted_qualifiers)

#fixing fraction
qaqc.output.bound$fraction<-as.character(qaqc.output.bound$fraction)
result.all$fraction<-as.character(result.all$fraction)

qaqc.output.bound<-qaqc.output.bound %>% 
  mutate(fraction=case_when(
    fraction=="TRUE"~"t",
    TRUE~fraction
  ))
result.all<-result.all %>% 
  mutate(fraction=case_when(
    fraction=="TRUE"~"t",
    TRUE~fraction
  ))

```


Join flags and related fields to results table
```{r Join QAQC flags}
result.all <- result.all %>% 
  mutate(chemical_name = tolower(chemical_name)) %>% 
  select(-validated_yn, -validator_qualifiers) # Removing these fields since they will be replaced

#making them both lowercase
result.all$fraction<-tolower(result.all$fraction)
qaqc.output.bound$fraction<-tolower(qaqc.output.bound$fraction)

#making the result values into the same format


result.all<-result.all %>% 
  select(sys_sample_code,sample_delivery_group,chemical_name,fraction, result_value,everything())

qaqc.output.bound<-qaqc.output.bound %>% 
  select(sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value,everything()) %>% 
  distinct()

#merge data frames with left join

#test
result.all_test<-result.all %>% 
  select(sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value) %>% 
  group_by(sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value) %>% 
  summarise(n=n())
#remove the extra ones
result_remove<-result.all_test %>% 
  ungroup() %>% 
  distinct() %>% 
  mutate(match=paste(sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value)) %>% 
  filter(n<2)

result.all_filter<-result.all %>% 
  mutate(match=paste(sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value)) %>% 
  filter(match %in% result_remove$match)

result.all.flags.left<-merge(result.all_filter,
                                 qaqc.output.bound,
                                 by = c(
                                   "sys_sample_code",
                                   "sample_delivery_group",
                                   "chemical_name",
                                   "fraction",
                                   "result_value"
                                 ),
                             all.x = TRUE) %>% 
  mutate(match=paste(sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value)) %>% 
  mutate(match2=paste(sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value)) %>% 
  group_by(sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value) %>% 
  mutate(n=n()) %>% 
  select(match2,sys_sample_code,sample_delivery_group,chemical_name,fraction,result_value,everything()) %>% 
  subset(project_name !="RIB_CEC" & project_name !="RIBs_CECs" )

#it's the CECs!! removing


# matches number of QAQC records in chunk above (all have match)

# Do antijoin to see if all records are all lab and QC samples.
# result.all.flags.anti <- anti_join(result.all, qaqc.output.bound, by = c("sys_sample_code", "sample_delivery_group", "chemical_name", "fraction"))
# result.sample.anti <- right_join(sample.all, result.all.flags.anti, by = c("sys_sample_code", "sample_delivery_group"))

# filter to non-lab and QC samples to verify what's missing was intentional (or that data frame is blank, as it typically should be)
result.sample.anti.sub <- result.sample.anti %>% 
  filter(sample_type_code %in% "N",
         DEC_sample_type %in% "N") 
unique(result.sample.anti.sub$SITE_ID)
# Found: nothing for hansgroot

#  Look for duplicate records (possible issues with join)
dups <- result.all.flags.left %>% 
  group_by(sys_sample_code, sample_delivery_group, chemical_name, fraction) %>% 
  mutate(dups = n()) %>% 
  filter(dups > 1)
 # Found: nothing for 2023

# Clean up dataframes and rename
result.all <- result.all.flags.left
rm(qaqc.output.bound, result.all.flags.left, result.all.flags.full, result.all.flags.inner, result.all.flags.anti, result.sample.anti, result.sample.anti.sub, dups,qa_mod1,qa_mod2,qa_mod3,qa_mod4)

```

Flag any field results not run through QAQC
```{r Populated flags fir non-QAQCd data}
# Join sample type field from SAMPLE table to gather required info for filtering
sample.all.type <- sample.all %>% 
  select(SITE_ID, sys_sample_code, sample_source, sample_delivery_group, DEC_sample_type, sample_type_code)
result.all.type <- left_join(result.all, sample.all.type, by = c("sys_sample_code", "sample_delivery_group")) %>% 
  # select(SITE_ID, sample_source, DEC_sample_type, sample_type_code, validator_qualifiers, VALIDATOR_QUAL_EXPLN, everything())
  select(SITE_ID, sample_source, DEC_sample_type, sample_type_code, everything())

# Check this to see what types of samples got flags. Only N and N_xxx samples should be getting flags.
result.all.type.check <- result.all.type %>% 
  select(validator_qualifiers, DEC_sample_type) %>% 
  distinct()
unique(result.all.type.check$DEC_sample_type)
#found - one for R2209099

# Filter out normal samples that didn't get flags to verify that only the ones intentionally not flagged are there.
result.all.notflagged.n <- result.all.type %>% 
  filter(is.na(validator_qualifiers),
         DEC_sample_type %in% "N",
         sample_source %in% "Field")
unique(result.all.notflagged.n$SITE_ID)
# Found: nothing for 2023

# Mark validated_yn as "N" for normal field samples with no validator flag. Add E flags and explanations if needed.
result.all.flagged2 <- result.all.type %>% 
  mutate(validated_yn = ifelse(
    is.na(validator_qualifiers) &
      DEC_sample_type %in% "N" &
      sample_source %in% "Field",
    "N", validated_yn)) 

#fixing missing site id
result.all.flagged2<-result.all.flagged2 %>% 
  mutate(SITE_ID=case_when( is.na(SITE_ID)~"10-BRTB-1.0",
                            TRUE~SITE_ID),
         sample_source=case_when(is.na(sample_source)~"Field",
                                 TRUE~sample_source),
         DEC_sample_type=case_when(is.na(DEC_sample_type)~"N",
                                   TRUE~DEC_sample_type),
         sample_type_code=case_when(is.na(sample_type_code)~"N",
                                    TRUE~sample_type_code))

  # mutate(validator_qualifiers = ifelse(
  #   is.na(validator_qualifiers) &
  #     DEC_sample_type %in% "N" &
  #     sample_source %in% "Field" &
  #     !grepl("*EMIL", SITE_ID) &
  #     !grepl("*UHUD", SITE_ID) &    # Added 2020-10-05
  #     !grepl("*MOHK", SITE_ID), 
  #   "E", validator_qualifiers)) %>% 
  # mutate(VALIDATOR_QUAL_EXPLN = ifelse(validator_qualifiers %in% "E", 
  #   "Not flagged due to QAQC error or insufficient QAQC sampling", VALIDATOR_QUAL_EXPLN)) 

# Verify that only remaining field "N" samples without flags are those params we don't flag
result.all.flagged2.naflags <- result.all.flagged2 %>% 
  filter(is.na(validator_qualifiers),
         sample_source %in% "Field",
         DEC_sample_type %in% "N")
# Triple check. Ignore me. Above checks out :)

# Clean up new result table and remove joined fields
result.all.flagged2 <- result.all.flagged2 %>% 
  select(-SITE_ID, -sample_source, -DEC_sample_type, -sample_type_code) 

rm(sample.all.type, result.all.type, result.all.type.check, result.all.notflagged.n, result.all.flagged2.naflags)


```


Join pcodes field using "pcode join table" (based on chemical_name, fraction, and unit)
updated for new Pcode on 6/6/23
```{r Join pcodes}

# Import pcodes 
pcode.join <- read_csv(file.path(datamod.dir, "Final_Chemistry_ITS","MASTER_S_CHEM_PARAMETER_2023-01-10.csv")) %>%
  select(CHEM_PARAMETER_SOURCE, everything()) %>% 
  # select(-"Has duplicate", -"Notes") %>% 
  mutate(chemical_name = tolower(CHEM_PARAMETER_NAME)) %>% 
  mutate(result_unit = tolower(CHEM_PARAMETER_UNIT_NOSP)) %>% 
  mutate(RESULT_TYPE = CHEM_PARAMETER_SOURCE) %>% 
  mutate(fraction = CHEM_PARAMETER_FRACTION) %>% 
  mutate(DEC_pcode_FINAL = CHEM_PARAMETER_PCODE) %>% 
  # mutate(DEC_pcode_FINAL = formatC(DEC_pcode_FINAL, width = 3, format = "d", flag = "0")) %>% 
  # Remove instances of duplicate rows that represented differing unit capitalization (will just do this in the data) 
  #  May not be relevent anymore
  distinct()

# Filter to lab only (non-insitu) for joining to chem data
pcode.join.lab <- pcode.join %>% 
  filter(RESULT_TYPE %in% "lab") %>%
  select(-RESULT_TYPE) %>% 
  mutate(fraction=tolower(fraction)) %>% 
  mutate(result_unit=tolower(result_unit)) %>% 
  mutate(fraction = case_when(
    fraction %in% "total"~"t",
    fraction %in% "dissolved"~"d",
    TRUE~fraction
  ))

result.all.flagged2$fraction<-tolower(result.all.flagged2$fraction)
result.all.flagged2$result_unit<-tolower(result.all.flagged2$result_unit)


# Join to chem results table
result.all.pcodes <- left_join(result.all.flagged2, pcode.join.lab, by = c("chemical_name", "fraction", "result_unit")) %>% 
  select(DEC_pcode_FINAL, chemical_name, everything())

# Return records that didn't get pcodes assigned
result.all.pcodes.na <- result.all.pcodes %>% 
  filter(is.na(DEC_pcode_FINAL))
sort(unique(result.all.pcodes.na$chemical_name))

# summarize join for review  
result.all.pcodes.check <- result.all.pcodes %>%
  select(DEC_pcode_FINAL, chemical_name, fraction, result_unit) %>%
  distinct()
print(result.all.pcodes.check)

result.all <- result.all.pcodes

rm(result.all.pcodes, pcode.join, pcode.join.lab, result.all.flagged2, result.all.pcodes.na, result.all.pcodes.check)


```


Reformat field names
```{r Reformat field names}
sample.all<-sample.all %>% 
  mutate(SITE_ID_CORR_IND = "") %>% 
  filter(.id !="2022_chem_preqaqc_-RIBS_CECs_2023-01-20.csv")

sample.all.form <- sample.all %>%
  rename_all(toupper) %>%
  rename(
    EVENT_SMAS_HISTORY_ID = SITE_ID,
    DEC_SAMPLE_TYPE_CDE = DEC_SAMPLE_TYPE,
    SYS_SAMPLE_CDE = SYS_SAMPLE_CODE,
    SAMPLE_MATRIX_CDE = SAMPLE_MATRIX_CODE,
    LAB_SAMPLE_TYPE_CDE = SAMPLE_TYPE_CODE,
    PARENT_SAMPLE_CDE = PARENT_SAMPLE_CODE,
    SAMPLE_DEL_GRP = SAMPLE_DELIVERY_GROUP,
    SYS_LOC_CDE = SYS_LOC_CODE,
    SAMPLE_DATETIME = SAMPLE_DATE,
    SITE_ID_CORR_YN = SITE_ID_CORR_IND
  ) %>%
  mutate(SAMPLE_DATETIME.posixct = as.POSIXct(SAMPLE_DATETIME, format = "%m/%d/%Y %H:%M:%S"),
         SAMPLE_DATETIME.posixct=case_when(
           is.na(SAMPLE_DATETIME.posixct)~as.POSIXct(SAMPLE_DATETIME, format = "%m/%d/%Y %H:%M"),
           TRUE~SAMPLE_DATETIME.posixct
         )) %>%
  mutate(EVENT_SMAS_SAMPLE_DATE = strftime(SAMPLE_DATETIME.posixct, "%m/%d/%Y")) %>%
  rename_all(function(x)
    paste0("CHS_", x))
# mutate(EVENT_SMAS_ID = paste0(CHS_SITE_ID,"_",EVENT_ID_DATE))

result.all.form <- result.all %>%
  rename_all(toupper) %>%
  mutate(QLFR_SRC = "AE") %>% 
  rename(
    SYS_SAMPLE_CDE = SYS_SAMPLE_CODE,
    LAB_ANAL_METHOD_NAME = LAB_ANL_METHOD_NAME,
    LAB_MATRIX_CDE = LAB_MATRIX_CODE,
    LAB_NAME_CDE = LAB_NAME_CODE,
    SUBSAMPLE_AMT = SUBSAMPLE_AMOUNT,
    SUBSAMPLE_AMT_UNIT = SUBSAMPLE_AMOUNT_UNIT,
    RESULT_TYPE_CDE = RESULT_TYPE_CODE,
    # REPORTABLE_RESULT_IND = REPORTABLE_RESULT,
    LAB_QUAL = LAB_QUALIFIERS,
    VALIDATOR_QUAL = VALIDATOR_QUALIFIERS,
    INTERPRETED_QUAL = INTERPRETED_QUALIFIERS,
    # VALIDATED_IND = VALIDATED_YN,
    METHOD_DETECT_LIMIT = METHOD_DETECTION_LIMIT,
    REPORTING_DETECT_LIMIT = REPORTING_DETECTION_LIMIT,
    QC_ORIG_CONC = QC_ORIGINAL_CONC,
    QC_DUP_ORIG_CONC = QC_DUP_ORIGINAL_CONC,
    SAMPLE_DEL_GRP = SAMPLE_DELIVERY_GROUP,
    VALIDATION_DATE = QAQC_DATE
  ) %>%
  # mutate(ANALYSIS_DATE = as.POSIXct(ANALYSIS_DATE, format = "%m/%d/%Y %H:%M:%S")) %>%
  # mutate(PREP_DATE = as.POSIXct(PREP_DATE, format = "%m/%d/%Y %H:%M:%S")) %>%
  mutate(VALIDATION_DATE = as.Date(VALIDATION_DATE, format = "%Y-%m-%d")) %>% 
  mutate(FRACTION = case_when(
    FRACTION == "t" ~ "TOTAL",
    FRACTION == "d" ~ "DISSOLVED",
    TRUE ~ FRACTION)) %>% 
  rename_all(function(x)
    paste0("CHR_", x)) %>% 
  rename(CHR_PCODE = CHR_DEC_PCODE_FINAL)
    # fixed above from CHEM_PCODE on 9/11/20 

```

Select final headers as per ITS data model
```{r Select final columns}

# SAMPLE table
sample.all.FINAL <- sample.all.form %>% 
    select(CHS_EVENT_SMAS_HISTORY_ID, CHS_EVENT_SMAS_SAMPLE_DATE, CHS_SITE_ID_CORR_YN, CHS_DATA_PROVIDER, CHS_SYS_SAMPLE_CDE, 
           CHS_SAMPLE_NAME, CHS_SAMPLE_MATRIX_CDE, CHS_DEC_SAMPLE_TYPE_CDE, CHS_LAB_SAMPLE_TYPE_CDE, CHS_SAMPLE_SOURCE, 
           CHS_PARENT_SAMPLE_CDE, CHS_SAMPLE_DEL_GRP, CHS_SAMPLE_DATETIME, CHS_SAMPLE_RECEIPT_DATE, CHS_SYS_LOC_CDE,
           CHS_CHAIN_OF_CUSTODY, CHS_SAMPLER, CHS_SAMPLING_COMPANY_CODE, CHS_COMMENT)

# RESULT table
result.all.FINAL <- result.all.form %>% 
  select(CHR_PCODE, CHR_SYS_SAMPLE_CDE, CHR_SAMPLE_DEL_GRP, CHR_LAB_ANAL_METHOD_NAME, CHR_ANALYSIS_DATE, CHR_TEST_TYPE, CHR_LAB_MATRIX_CDE, 
         CHR_DILUTION_FACTOR, CHR_PREP_METHOD, CHR_PREP_DATE, CHR_LAB_NAME_CDE, CHR_QC_LEVEL, CHR_LAB_SAMPLE_ID, CHR_SUBSAMPLE_AMT, 
         CHR_SUBSAMPLE_AMT_UNIT, CHR_FINAL_VOLUME, CHR_FINAL_VOLUME_UNIT, CHR_CAS_RN, CHR_RESULT_VALUE, 
         CHR_RESULT_TYPE_CDE, CHR_REPORTABLE_RESULT, CHR_DETECT_FLAG, CHR_QLFR_SRC, CHR_LAB_QUAL, CHR_VALIDATED_YN, CHR_VALIDATION_DATE, CHR_VALIDATOR_QUAL, 
         CHR_VALIDATOR_QUAL_EXPLN, CHR_METHOD_DETECT_LIMIT, 
         CHR_REPORTING_DETECT_LIMIT, CHR_QUANTITATION_LIMIT, CHR_DETECTION_LIMIT_UNIT, CHR_RESULT_COMMENT, CHR_QC_ORIG_CONC, 
         CHR_QC_SPIKE_ADDED, CHR_QC_SPIKE_MEASURED, CHR_QC_SPIKE_RECOVERY, CHR_QC_DUP_ORIG_CONC, CHR_QC_DUP_SPIKE_ADDED, CHR_QC_DUP_SPIKE_MEASURED, 
         CHR_QC_DUP_SPIKE_RECOVERY, CHR_QC_RPD, CHR_QC_SPIKE_LCL, CHR_QC_SPIKE_UCL, CHR_QC_RPD_CL, CHR_QC_SPIKE_STATUS, CHR_QC_DUP_SPIKE_STATUS, 
         CHR_QC_RPD_STATUS)

```

Convert NAs to text for not_null fields (for coded tables)
```{r Convert NAs for non_nulls}
result.all.FINAL <- result.all.FINAL %>% 
  mutate(CHR_LAB_QUAL = ifelse(is.na(CHR_LAB_QUAL), "0", CHR_LAB_QUAL),
         CHR_LAB_QUAL = ifelse(CHR_LAB_QUAL %in% "", "0", CHR_LAB_QUAL),
         CHR_VALIDATOR_QUAL = ifelse(is.na(CHR_VALIDATOR_QUAL), "0", CHR_VALIDATOR_QUAL))
```

Generate list of unique values for review
```{r View unique values, eval = FALSE}

sample.unique <- lapply(sample.all.FINAL, unique)
result.unique <- lapply(result.all.FINAL, unique)

# Check unique lab_qualifiers to make sure all are already included in table S_CHEM_QUALIFIER_LAB.

```

```{r Other final modifications}

# Change DEC sample type DUPs to SEQs (switched starting in 2020 to differentiate from old dup type)
#     They are set as DUP in the raw script in order to be compatible with the QAQC script (along w LMAS). But in final DB they should be SEQ.
# Format dates as dates to verify by sorting, then to the proper ITS format.
sample.all.FINAL <- sample.all.FINAL %>% 
  mutate(CHS_DEC_SAMPLE_TYPE_CDE = ifelse(CHS_DEC_SAMPLE_TYPE_CDE %in% "DUP", "SEQ", CHS_DEC_SAMPLE_TYPE_CDE),
         # Consider incorporating this into validation script (make SEQ to begin with and change to DUP in QAQC script's getting.started.R)
         CHS_DEC_SAMPLE_TYPE_CDE = ifelse(CHS_DEC_SAMPLE_TYPE_CDE %in% "N_DUPPARENT", "N_SEQPARENT", CHS_DEC_SAMPLE_TYPE_CDE),
         CHS_EVENT_SMAS_SAMPLE_DATE = as.Date(CHS_EVENT_SMAS_SAMPLE_DATE, format = "%m/%d/%Y"),
         CHS_EVENT_SMAS_SAMPLE_DATE = format((CHS_EVENT_SMAS_SAMPLE_DATE), "%m/%d/%Y"),
         CHS_SAMPLE_RECEIPT_DATE = as.Date(CHS_SAMPLE_RECEIPT_DATE, format = "%m/%d/%Y"),
         CHS_SAMPLE_RECEIPT_DATE = format((CHS_SAMPLE_RECEIPT_DATE), "%m/%d/%Y"),
        # CHS_SAMPLE_DATETIME = as.POSIXct(CHS_SAMPLE_DATETIME, format = "%m/%d/%Y %H:%M:%S"),
        # CHS_SAMPLE_DATETIME = format((CHS_SAMPLE_DATETIME), "%m/%d/%Y %H:%M:%S"),
         CHS_SAMPLE_DATETIME = as.POSIXct(CHS_SAMPLE_DATETIME, format = "%m/%d/%Y %H:%M"),
         CHS_SAMPLE_DATETIME = format((CHS_SAMPLE_DATETIME), "%m/%d/%Y %H:%M"))%>% 
  mutate(CHS_SAMPLE_DEL_GRP_EQUIS="")

stopifnot( "There is problem withe the CHS_SAMPLE_DATETIME format"=
  !is.na(sample.all.FINAL$CHS_SAMPLE_DATETIME))

result.all.FINAL <- result.all.FINAL %>% 
  mutate(#CHR_ANALYSIS_DATE = as.POSIXct(CHR_ANALYSIS_DATE, format = "%m/%d/%Y %H:%M:%S"),
         #CHR_ANALYSIS_DATE = format((CHR_ANALYSIS_DATE), "%m/%d/%Y %H:%M:%S"),
         CHR_ANALYSIS_DATE = as.POSIXct(CHR_ANALYSIS_DATE, format = "%m/%d/%Y %H:%M"),
         CHR_ANALYSIS_DATE = format((CHR_ANALYSIS_DATE), "%m/%d/%Y %H:%M")
)

stopifnot( "There is problem withe the CHR_ANALYSIS_DATE format"=
  !is.na(result.all.FINAL$CHR_ANALYSIS_DATE))

# After running above, open table and manually sort date fields to look for formatting inconsistencies from ALS (top/bottom).
# Correct here if any errors.
#3/21/21 Looks ok to me
#6/6/23 Looks ok

```


```{r Crosscheck-event-IDs-against-Charlies-in-situ}

insitu.master <- read_csv(file.path(datamod.dir, "Final_SBU_Field_ITS", "Master_S_IN_SITU_WATER_CHEM_v4_Internal_Format_created_2021_12_07.csv")) 

# Return records for which there are no in-situ records present. Look into these w Charlie.
samp.eventid.check <- sample.all.FINAL %>% 
  mutate(event_id_date = as.Date(CHS_EVENT_SMAS_SAMPLE_DATE, format = "%m/%d/%Y"),
         event_id_date = format(event_id_date, "%Y%m%d"),
         EVENT_SMAS_ID = paste0(CHS_EVENT_SMAS_HISTORY_ID,"_",event_id_date)) %>% 
  filter(!CHS_EVENT_SMAS_HISTORY_ID %in% "00-QAQC-0.0",
         CHS_SAMPLE_SOURCE %in% "Field",
         !EVENT_SMAS_ID %in% insitu.master$EVENT_SMAS_ID)

write.csv(samp.eventid.check,here::here("data/2022/final/no_matching_in_situ.csv"))
```


```{r Test table joins}

# To ensure record numbers match after all adjustments above.

test.sample.all.FINAL <- sample.all.FINAL %>% 
  rename(SSC = CHS_SYS_SAMPLE_CDE,
         SDG = CHS_SAMPLE_DEL_GRP)
test.result.all.FINAL <- result.all.FINAL %>% 
  rename(SSC = CHR_SYS_SAMPLE_CDE,
         SDG = CHR_SAMPLE_DEL_GRP)

test.sample.result <- left_join(test.sample.all.FINAL, test.result.all.FINAL, by = c("SSC", "SDG")) 
# checks out okay kar 3/21/21
rm(test.sample.all.FINAL, test.result.all.FINAL, test.sample.result)

```

```{r Test pcode join}

pcode <- read.csv(file.path(datamod.dir, "Final_Chemistry_ITS", "MASTER_S_CHEM_PARAMETER_2022-03-08.csv"), stringsAsFactors = FALSE, colClasses = "character") %>% 
  mutate(CHEM_PARAMETER_PCODE = as.integer(CHEM_PARAMETER_PCODE))
         # CHEM_PARAMETER_PCODE = sprintf("%03d", CHEM_PARAMETER_PCODE)) 

# Review this table to ensure all pcode info joined (look for NAs or blanks)
test.result.pcode <- result.all.form %>% 
  rename(CHEM_PARAMETER_PCODE = CHR_PCODE) %>% 
  left_join(pcode, by = "CHEM_PARAMETER_PCODE") %>% 
  select(CHEM_PARAMETER_PCODE, CHEM_PARAMETER_NAME, CHR_CHEMICAL_NAME, CHEM_PARAMETER_UNIT_NOSP, CHR_RESULT_UNIT,
         CHEM_PARAMETER_FRACTION, CHR_FRACTION) %>% 
  unique() %>% 
  mutate(CHR_CHEMICAL_NAME_caps = toupper(CHR_CHEMICAL_NAME))

```

Generate EVENT ID records for Charlie to crosscheck against, and append to survey event IDs
```{r Generate event IDs}

#Offer these to charlie if he wants to crosscheck, or work together on crosschecking.
event.id <- sample.all.FINAL %>% 
  distinct(CHS_EVENT_SMAS_HISTORY_ID, CHS_EVENT_SMAS_SAMPLE_DATE)

write.csv(event.id,here::here("data/2023/event_id_2023_all.csv"))

```



```{r event_id_check}

event<-readxl::read_excel(paste(datamod.dir,"/Final_Event_ID_ITS/Master_S_Event_SMAS_ID_v2_created_20211116.xlsx",sep = ""))

site_check<-readxl::read_excel(paste(datamod.dir,"/Final_Sites_ITS/c2021_Sites_crosswalk_summary_v4_created_20211116.xlsx",sep = ""))

site.check.short<-site_check %>% 
  filter(`Site ID updated?`=="T") %>% 
  select(SMAS_HISTORY_ID,ORIGINAL_SITE_ID,EVENT_SMAS_SAMPLE_DATE)

site.check.l<-unique(site.check.short$ORIGINAL_SITE_ID)

change<-sample.all.FINAL %>% 
  filter(CHS_EVENT_SMAS_HISTORY_ID %in% site.check.l)

#update the files and re-write them
sample.all.FINAL_cor<-merge(sample.all.FINAL,site.check.short,
                        by.x=c("CHS_EVENT_SMAS_HISTORY_ID","CHS_EVENT_SMAS_SAMPLE_DATE"),
                        by.y=c("ORIGINAL_SITE_ID","EVENT_SMAS_SAMPLE_DATE"),
                        all.x = TRUE)

sample.all.FINAL_cor<-sample.all.FINAL_cor %>% 
  mutate(CHS_EVENT_SMAS_HISTORY_ID=case_when(!is.na(SMAS_HISTORY_ID)~SMAS_HISTORY_ID,
                                             TRUE~CHS_EVENT_SMAS_HISTORY_ID)) %>% 
  select(-c(SMAS_HISTORY_ID))

#so now i think that if it's fine in that file, it's fine in the others, because it will attach with the sys_sample_code?

#finish up the change to that one sample
sample.all.FINAL_cor<-sample.all.FINAL_cor %>% 
  mutate(CHS_DEC_SAMPLE_TYPE_CDE=case_when(CHS_SYS_SAMPLE_CDE=="02-GOOS-2.9-09152021-W-SEQ"~"N",
                                           CHS_SYS_SAMPLE_CDE=="02-GOOS-2.9-09152021-W"~"	
N_SEQPARENT",
                                           TRUE~CHS_DEC_SAMPLE_TYPE_CDE))

#and then reject the iron result?

result.all.FINAL_cor1<-result.all.FINAL %>% 
  mutate(CHR_VALIDATOR_QUAL=case_when(CHR_SYS_SAMPLE_CDE=="02-GOOS-2.9-09152021-W"& CHR_PCODE=="67"~"R",
                                      TRUE~CHR_VALIDATOR_QUAL))

#so now let's crosswalk with the event table
c2022_event<-sample.all.FINAL_cor %>% 
  select("CHS_EVENT_SMAS_HISTORY_ID","CHS_EVENT_SMAS_SAMPLE_DATE") %>% 
  rename("EVENT_SMAS_HISTORY_ID"="CHS_EVENT_SMAS_HISTORY_ID",
         "EVENT_SMAS_SAMPLE_DATE"="CHS_EVENT_SMAS_SAMPLE_DATE") %>% 
  distinct()

non_match<-anti_join(c2022_event,event,
                     by=c("EVENT_SMAS_SAMPLE_DATE","EVENT_SMAS_HISTORY_ID"))
non_match<-non_match %>% 
  filter(EVENT_SMAS_HISTORY_ID!="00-QAQC-0.0")

write.table(non_match, file = file.path(target.dir, "missing_event.csv"),sep=",", row.names = FALSE, na = "")

```

```{r fix-event-ids-from-crosswalk}

sample.all.FINAL_cor2<-sample.all.FINAL_cor %>% 
  mutate(CHS_EVENT_SMAS_SAMPLE_DATE=case_when(CHS_EVENT_SMAS_HISTORY_ID=="04-GENS-2.6"&
                                                CHS_EVENT_SMAS_SAMPLE_DATE=="08/16/2021"~"08/17/2021",
                                              TRUE~CHS_EVENT_SMAS_SAMPLE_DATE)) %>% 
         mutate(CHS_EVENT_SMAS_HISTORY_ID=case_when(CHS_EVENT_SMAS_HISTORY_ID=="12-STLE-0.8"~"12-STLE-0.2",
                                                    CHS_EVENT_SMAS_HISTORY_ID=="12-MOHK-1.5"~"12-MOHK-3.7",
                                                    TRUE~CHS_EVENT_SMAS_HISTORY_ID))


#same for result table
# result.all.FINAL_cor2<-result.all.FINAL_cor1 %>% 
#   mutate(CHS_EVENT_SMAS_SAMPLE_DATE=case_when(CHS_EVENT_SMAS_HISTORY_ID=="04-GENS-2.6"&
#                                                 CHS_EVENT_SMAS_SAMPLE_DATE=="08/16/2021"~"08/17/2021",
#                                               TRUE~CHS_EVENT_SMAS_SAMPLE_DATE)) %>% 
#          mutate(CHS_EVENT_SMAS_HISTORY_ID=case_when(CHS_EVENT_SMAS_HISTORY_ID=="12-STLE-0.8"~"12-STLE-0.2",
#                                                     CHS_EVENT_SMAS_HISTORY_ID=="12-MOHK-1.5"~"12-MOHK-3.7",
#                                                     TRUE~CHS_EVENT_SMAS_HISTORY_ID))
# 

```



Export tables
```{r Export tables, eval = FALSE}

# write.table(event.id, file = file.path(datamod.dir, "20210415_SMAS_chem_2020_event_IDs.csv"),sep=",", row.names = FALSE, na = "")
write.table(sample.all.FINAL, file = file.path(target.dir, "SMAS_chem_2023_SAMPLE.csv"),sep=",", row.names = FALSE, na = "")
write.table(result.all.FINAL, file = file.path(target.dir, "SMAS_chem_2023_RESUL.csv"),sep=",", row.names = FALSE, na = "")

```

Append to the datamod tables

```{r data-mod-tables}

sample_hist<-read.csv(paste(datamod.dir,"/Final_Chemistry_ITS/MASTER_S_CHEM_HISTORY_SAMPLE_2022-04-01.csv",sep = ""))

sample.all.FINAL_cor2$X<-""

sample_merged<-rbind(sample.all.FINAL_cor2,sample_hist)
#add row number to the new ones
sample_merged<-sample_merged %>% 
  arrange(as.numeric(X)) %>% 
  mutate(X=case_when(X==""~paste(seq.int(nrow(sample_merged))),
         TRUE~X))

result_hist<-read.csv(paste(datamod.dir,"/Final_Chemistry_ITS/MASTER_S_CHEM_HISTORY_RESULT_2022-04-01.csv",sep = ""))
result.all.FINAL_cor1$CHR_SAMPLE_DEL_GRP_EQUIS<-""
result.all.FINAL_cor1$CHS_EVENT_SMAS_HISTORY_ID<-NULL
result.all.FINAL_cor1$CHS_EVENT_SMAS_SAMPLE_DATE<-NULL

result_merged<-plyr::rbind.fill(result_hist,result.all.FINAL_cor1)

result_merged<-result_merged %>% 
  arrange(as.numeric(X)) %>% 
  mutate(X=paste(seq.int(nrow(result_merged))))

#write these to the datamod folders

write.csv(sample_merged,paste(datamod.dir,"/Final_Chemistry_ITS/MASTER_S_CHEM_HISTORY_SAMPLE_2023-01-09.csv",
                              sep = ""))

write.csv(result_merged,paste(datamod.dir,"/Final_Chemistry_ITS/MASTER_S_CHEM_HISTORY_RESULT_2023-01-09.csv",
                              sep = ""))

```

