---
title: "historic_chem_updates_2022-03-07"
author: "glemley"
date: "3/7/2022"
output: html_document
---

```{r Load in libs, set project dirs}
library(tidyverse)

root.dir <- rprojroot::find_root("chem_hist_cleaning.Rproj")
target.dir <- file.path(root.dir, "data", "2021", "hist_chem_updates")
datamod.dir <- "C:/Users/gmlemley/New York State Office of Information Technology Services/SMAS - Streams Data Modernization/Cleaned Files/"

```

```{r Load in master chem tables and pcodes}

chem.sample <- read.csv(file.path(datamod.dir, "Final_Chemistry_ITS", "MASTER_S_CHEM_HISTORY_SAMPLE_2021-12-27.csv"))

chem.sample.sub <- chem.sample %>%
  select(CHS_SYS_SAMPLE_CDE, CHS_SAMPLE_DEL_GRP, CHS_EVENT_SMAS_SAMPLE_DATE, CHS_DEC_SAMPLE_TYPE_CDE, CHS_LAB_SAMPLE_TYPE_CDE, CHS_SAMPLE_SOURCE)

chem.result <- read.csv(file.path(datamod.dir, "Final_Chemistry_ITS", "MASTER_S_CHEM_HISTORY_RESULT_2021-05-03.csv"))


```

```{r Converting pre-2018 lab flags}

## The validator qualifiers indicate flags produced by the QA/QC script.
## The QA/QC script was not developed/used until 2018.
## The following code populates the the pre-2018 with the most comprehensive
## flag that can be applied at this time based on the available lab qualifiers.

# Pull date from sample table for subsetting
chem.sample.date <- chem.sample %>%
  select(CHS_SYS_SAMPLE_CDE, CHS_SAMPLE_DEL_GRP, CHS_EVENT_SMAS_SAMPLE_DATE)

# Join date, filter to pre-2018, and filter to just records with flags we will convert.
chem.r.update <- chem.result %>%
  left_join(chem.sample.date, by = c("CHR_SYS_SAMPLE_CDE" = "CHS_SYS_SAMPLE_CDE", "CHR_SAMPLE_DEL_GRP" = "CHS_SAMPLE_DEL_GRP")) %>%
  mutate(date = as.Date(CHS_EVENT_SMAS_SAMPLE_DATE, "%m/%d/%Y")) %>%
  filter(date < as.Date("2018-01-01")) %>%
  filter(grepl("B|N|\\*|D|W|E|J|U", CHR_LAB_QUAL))

# Export these records for ITS to delete from DB
chem.r.delete.export <- chem.r.update %>%
  select(-CHS_EVENT_SMAS_SAMPLE_DATE, -date)
write.table(chem.r.delete.export, file = file.path(datamod.dir,"Final_Chemistry_ITS", "2021_UPDATES", "DELETE_RECS-S_CHEM_HISTORY_RESULT.csv"),sep=",", row.names = FALSE, na = "")

# Convert lab flags to validator qualifiers and export records to ITS to append to DB
chem.r.update2 <- chem.r.update %>%
  mutate(
    CHR_VALIDATOR_QUAL = case_when(
      grepl("B|N|\\*|D|W", CHR_LAB_QUAL) ~ "R",
      grepl("E|J", CHR_LAB_QUAL) ~ "J",
      grepl("U", CHR_LAB_QUAL) ~ "U",
      TRUE ~ CHR_VALIDATOR_QUAL
    )
  ) %>%
  select(-CHS_EVENT_SMAS_SAMPLE_DATE, -date)

# Export these records for ITS to append to DB
# write.table(chem.r.update2, file = file.path(datamod.dir,"Final_Chemistry_ITS", "2021_UPDATES", "APPEND_RECS-S_CHEM_HISTORY_RESULT.csv"),sep=",", row.names = FALSE, na = "")

### Delete/append these records to the master result table and export new version
chem.r.master.update <- chem.result %>%
  anti_join(chem.r.delete.export) %>%
  bind_rows(chem.r.update2)

# write.table(chem.r.master.update, file = file.path(datamod.dir,"Final_Chemistry_ITS", "MASTER_S_CHEM_HISTORY_RESULT_2022-03-07.csv"),sep=",", row.names = FALSE, na = "")

```

```{r  Apply flags to TN and nitrate data based on parent param flags}

# get sample date to join
chem.sample.date <- chem.sample %>%
  select(CHS_SYS_SAMPLE_CDE, CHS_SAMPLE_DEL_GRP, CHS_EVENT_SMAS_SAMPLE_DATE)

# Load new chem result table (after above processing)
chem.result <- read.csv(file.path(datamod.dir, "Final_Chemistry_ITS", "MASTER_S_CHEM_HISTORY_RESULT_2022-03-07.csv")) %>%
  left_join(chem.sample.date, by = c("CHR_SYS_SAMPLE_CDE" = "CHS_SYS_SAMPLE_CDE", "CHR_SAMPLE_DEL_GRP" = "CHS_SAMPLE_DEL_GRP"))

# Load pcode table
pcode <- read.csv(file.path(datamod.dir, "Final_Chemistry_ITS", "MASTER_S_CHEM_PARAMETER_2022-03-03.csv"))

# chem.result.pcode <- read.csv(file.path(datamod.dir, "Final_Chemistry_ITS", "MASTER_S_CHEM_HISTORY_RESULT_2021-05-03.csv")) %>%
  # left_join(pcode, by = c("CHR_PCODE" = "CHEM_PARAMETER_PCODE")) %>%
  # left_join(chem.sample.sub, by = c("CHR_SYS_SAMPLE_CDE" = "CHS_SYS_SAMPLE_CDE", "CHR_SAMPLE_DEL_GRP" = "CHS_SAMPLE_DEL_GRP")) %>%
  # mutate(date = as.Date(CHS_EVENT_SMAS_SAMPLE_DATE, "%m/%d/%Y"))


### Use zach's code below or code from two chunks copied from QAQC script below.


# pcodes:
# 100 = NITRATE
# 101 = NITRATE-NITRITE
# 102 = NITRITE

new_codes<-chem.result %>% 
  filter(CHR_PCODE==102) %>% select(CHR_SYS_SAMPLE_CDE,CHS_EVENT_SMAS_SAMPLE_DATE) %>% distinct()
if(nrow(new_codes)>0){
  noxni<-chem.result %>% filter(CHR_PCODE %in% c(101, 102)) %>% distinct()
  new_codes<-merge(new_codes,noxni,by=c('CHR_SYS_SAMPLE_CDE','CHS_EVENT_SMAS_SAMPLE_DATE'),all.x = TRUE)
  new_codes<-new_codes %>% 
    select(CHR_SYS_SAMPLE_CDE,CHR_VALIDATOR_QUAL) %>% distinct() %>% 
    filter(!is.na(CHR_VALIDATOR_QUAL),
           CHR_VALIDATOR_QUAL %in% c('R','T')) %>% 
    arrange(CHR_SYS_SAMPLE_CDE,CHR_VALIDATOR_QUAL) %>% 
    #since these are arranged alphabetically, the R will be accepted over T
    distinct(CHR_SYS_SAMPLE_CDE,.keep_all = TRUE) %>% 
    mutate(new_codes=CHR_VALIDATOR_QUAL) %>% 
    select(CHR_SYS_SAMPLE_CDE,new_codes) %>% distinct()
  data2<-merge(chem.result,new_codes,by=c('CHR_SYS_SAMPLE_CDE'),all=TRUE)
  data3<-data2 %>% 
    mutate(CHR_VALIDATOR_QUAL=ifelse(!is.na(new_codes)&CHR_PCODE==100,new_codes,CHR_VALIDATOR_QUAL)) %>% 
    select(-new_codes) %>% 
    mutate(CHR_VALIDATOR_QUAL_EXPLN=ifelse(CHR_VALIDATOR_QUAL %in% c('R','T')&CHR_PCODE==100,"calculated parameter_see components",CHR_VALIDATOR_QUAL_EXPLN))
  # rm(noxni)
}


# Now export for ITS (recs to delete/append) and update master table



### Zach's code (not used)

nitrate_flags <- function(x) {
  # If there is no nitrate data, then there are no flags to apply.  
  if (!any(grepl("nitrate", x$parameter))) return(x)
  # If there is no nitrite data, then there are no flags to apply.  
  if (!any(grepl("nitrite", x$parameter))) return(x)
  # List of DFs each representing a single parameter.  
  param_split <- split(
    x = x,
    f = x$parameter  )
  # Append the nitrite and nitrate+nitrite values into a single DF.  
  nitro_append <- rbind(param_split$nitrite,
                        param_split$nitrate_nitrite)
  # Subset columns.  
  nitro_select <- unique(nitro_append[c("sample_id",
                                        "parameter",
                                        "fraction",
                                        "method_speciation",
                                        "validator_qualifiers")])
  
  # Filters -----------------------------------------------------------------  
  ## fraction should be total  
  fraction_filter <- nitro_select$fraction == "total"  
  # method_speciation should be as N  
  species_filter <- nitro_select$method_speciation == "as N"  
  ## Apply the filters  
  nitro_filter <- nitro_select[fraction_filter & species_filter, ]
  
  # Get Worst Flag ----------------------------------------------------------  
  ## Assign a hierarchy to the flags.  
  nitro_filter$flag <- ordered(
    x = nitro_filter$validator_qualifiers,
    levels = c("a", "u", "j", "t", "r")
  )
  ## Get the max flag i.e., the worst flag.  
  nitro_worst_flag <- aggregate(flag ~ sample_id,
                                FUN = max,
                                data = nitro_filter)
  ## Merge the worst flag to the nitrate DF.  
  param_split$nitrate <- merge(
    x = param_split$nitrate,
    y = nitro_worst_flag,
    by = "sample_id",
    all.x = TRUE,
    all.y = FALSE  )
  
  # Overwrite the validator_qualifiers --------------------------------------  
  ## If validator_qualifiers is NA or the nitrite/nitrate+nitrite flag  
  ## is reject or trend, then overwrite the nitrate validator_qualifier.  
  ## Otherwise keep the current validator_qualifier.  
  param_split$nitrate$validator_qualifiers <- ifelse(
    test = is.na(param_split$nitrate$validator_qualifiers) |      
      param_split$nitrate$flag %in% c("r", "t"),
    yes = param_split$nitrate$flag,
    no = param_split$nitrate$validator_qualifiers  
  )
  # Remove the flag column-- it is no longer needed.  
  param_split$nitrate$flag <- NULL  
  
  # Combine -----------------------------------------------------------------  
  ## Append the parameter DFs into a single DF.  
  final_df <- do.call(rbind, param_split)
  # End of function. Return a DF.  
  return(final_df)
}


```


```{r Remove historic non-detects result values that were set as the MDL/QL by EQuiS}



```



### Nitrate Flags

If Nitrate/Nitrite or Nitrite parameters are flagged as R (rejected) or T (trend) then these flags are transferred to Nitrate in that priority (R is added over T if both are listed for that sys_sample_code).

```{r, echo=FALSE, warning=FALSE}
new_codes<-data %>% filter(chemical_name=="nitrogen, nitrite") %>% select(sys_sample_code,sample_date) %>% distinct()
if(nrow(new_codes)>0){
  noxni<-data %>% filter(chemical_name %in% c('nitrate+nitrite as nitrogen','nitrogen, nitrite')) %>% distinct()
  new_codes<-merge(new_codes,noxni,by=c('sys_sample_code','sample_date'),all.x = TRUE)
  new_codes<-new_codes %>% 
    select(sys_sample_code,validator_qualifiers) %>% distinct() %>% 
    filter(!is.na(validator_qualifiers),
           validator_qualifiers %in% c('R','T')) %>% 
    arrange(sys_sample_code,validator_qualifiers) %>% 
    #since these are arranged alphabetically, the R will be accepted over T
    distinct(sys_sample_code,.keep_all = TRUE) %>% 
    mutate(new_codes=validator_qualifiers) %>% 
    select(sys_sample_code,new_codes) %>% distinct()
  data<-merge(data,new_codes,by=c('sys_sample_code'),all=TRUE)
  data<-data %>% 
    mutate(validator_qualifiers=ifelse(!is.na(new_codes)&chemical_name=="nitrogen, nitrate (as n)",new_codes,validator_qualifiers)) %>% 
    select(-new_codes) %>% 
    mutate(interpreted_qualifiers=ifelse(validator_qualifiers %in% c('R','T')&chemical_name=="nitrogen, nitrate (as n)","calculated parameter_see components",interpreted_qualifiers))
  rm(noxni)
}
rm(new_codes)
```

### Total Nitrogen Flags

If TKN or NOX parameters are flagged as R (rejected) or T (trend) then these flags are transferred to Total Nitrogen in that priority (R is added over T if both are listed for that sys_sample_code).

```{r, echo=FALSE, warning=FALSE}
new_codes<-data %>% filter(chemical_name=="nitrogen") %>% select(sys_sample_code,sample_date) %>% distinct()
if(nrow(new_codes)>0){
  nox_tkn<-data %>% filter(chemical_name %in% c('nitrate+nitrite as nitrogen','nitrogen, kjeldahl, total')) %>% distinct()
  new_codes<-merge(new_codes,nox_tkn,by=c('sys_sample_code','sample_date'),all.x = TRUE)
  new_codes<-new_codes %>% 
    select(sys_sample_code,validator_qualifiers) %>% distinct() %>% 
    filter(!is.na(validator_qualifiers),
           validator_qualifiers %in% c('R','T')) %>% 
    arrange(sys_sample_code,validator_qualifiers) %>% 
    #since these are arranged alphabetically, the R will be accepted over T
    distinct(sys_sample_code,.keep_all = TRUE) %>% 
    mutate(new_codes=validator_qualifiers) %>% 
    select(sys_sample_code,new_codes) %>% distinct()
  data2<-merge(data,new_codes,by=c('sys_sample_code'),all=TRUE)
  data2<-data2 %>% 
    mutate(validator_qualifiers=ifelse(!is.na(new_codes)&chemical_name=="nitrogen",new_codes,validator_qualifiers)) %>% 
    select(-new_codes) %>% 
    mutate(interpreted_qualifiers=ifelse(validator_qualifiers %in% c('R','T')&chemical_name=="nitrogen","calculated parameter_see components",interpreted_qualifiers))
  rm(nox_tkn)
}
# rm(new_codes)
```